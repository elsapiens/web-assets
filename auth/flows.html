<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ElAuth – Flows</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --white: #ffffff;
      --panel: #ffffff;
      --panel2: #f8fafc;
      --border: #e2e8f0;
      --text: #2c3e50;
      --muted: #64748b;
      --muted2: #94a3b8;
      --accent: #5a6f94;
      --accent2: #8197c0;
      --primary: #8197c0;
      --primary-dark: #5a6f94;
      --primary-light: #a8b9d4;
      --primary-lighter: #e8edf4;
      --good: #22c55e;
      --good-light: #dcfce7;
      --warn: #f59e0b;
      --warn-light: #fef3c7;
      --bad: #ef4444;
      --bad-light: #fee2e2;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { min-height: 100%; }

    html {
      background: var(--bg);
    }

    body {
      margin: 0;
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      background: var(--bg);
    }

    a { color: var(--primary-dark); }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 20px 46px;
    }

    header {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
      background: var(--white);
      padding: 20px 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .title {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      letter-spacing: -0.02em;
      font-size: clamp(22px, 3vw, 28px);
      line-height: 1.2;
      color: var(--text);
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      max-width: 92ch;
      line-height: 1.5;
      font-size: 13px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      background: var(--primary-lighter);
      border-radius: 999px;
      font-size: 12px;
      color: var(--primary-dark);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--muted);
      white-space: nowrap;
    }

    .pill b {
      color: var(--text);
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .card {
      grid-column: span 12;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--white);
      box-shadow: var(--shadow);
    }

    .cardHeader {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 20px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--radius) var(--radius) 0 0;
      color: white;
    }

    /* Sticky Flows Header */
    .flowsCard {
      position: relative;
    }

    .flowsCard > .cardHeader {
      position: sticky;
      top: 0;
      z-index: 101;
      backdrop-filter: blur(10px);
    }

    .cardHeader h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: -0.01em;
      color: white;
    }

    .cardHeader p {
      margin: 6px 0 0;
      color: rgba(255,255,255,0.85);
      font-size: 12px;
      line-height: 1.45;
      max-width: 92ch;
    }

    .cardHeader .pill {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
      color: white;
    }

    .cardHeader .pill b {
      color: white;
    }

    .cardBody {
      padding: 16px 20px 20px;
      flex: 1;
      min-width: 0;
    }

    .twoCol {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 940px) {
      .span7 { grid-column: span 7; }
      .span5 { grid-column: span 5; }
      .twoCol { grid-template-columns: 1fr 1fr; }
    }

    .sectionLabel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 0 0 10px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
    }

    .steps { display: grid; gap: 10px; }

    .step {
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 10px;
      padding: 12px;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: start;
    }

    .num {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-family: var(--mono);
      color: white;
      background: var(--primary);
      flex: none;
    }

    .stepTitle {
      margin: 0;
      font-size: 13px;
      color: var(--text);
      font-weight: 600;
      line-height: 1.35;
    }

    .stepMeta {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .diagramWrap {
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
    }

    .diagram {
      display: inline-block;
      min-width: 860px;
      width: 100%;
      max-width: 1300px;
    }

    svg { width: 100%; height: auto; display: block; }

    code {
      font-family: var(--mono);
      font-size: 0.9em;
      color: var(--primary-dark);
      background: var(--primary-lighter);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* Tabs Layout Container */
    .tabsContainer {
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 768px) {
      .tabsContainer {
        flex-direction: row;
      }
    }

    /* Tabs Sidebar */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    @media (min-width: 768px) {
      .tabs {
        flex-direction: column;
        flex-wrap: nowrap;
        width: 340px;
        min-width: 340px;
        border-bottom: none;
        border-right: 1px solid var(--border);
        border-radius: 0 0 0 var(--radius);
        position: sticky;
        top: 65px;
        height: fit-content;
        max-height: calc(100vh - 65px);
        overflow-y: auto;
        align-self: flex-start;
      }
    }

    .tab {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.3;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    @media (min-width: 768px) {
      .tab {
        text-align: left;
        border-radius: 0 8px 8px 0;
        white-space: nowrap;
      }
    }

    .tab:hover {
      background: var(--primary-lighter);
      color: var(--primary-dark);
    }
    .tab[aria-selected="true"] {
      color: var(--primary-dark);
      background: var(--primary-lighter);
      border-left-color: var(--primary);
      font-weight: 600;
    }

    .tabpanel { display: none; }
    .tabpanel.active { display: block; }

    /* Sub-tabs (used inside a panel) */
    .subtabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .subtab {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--muted);
      padding: 7px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      line-height: 1;
      transition: all 0.2s ease;
    }

    .subtab:hover {
      border-color: var(--primary-light);
      color: var(--primary-dark);
    }
    .subtab[aria-selected="true"] {
      color: white;
      border-color: var(--primary);
      background: var(--primary);
    }

    .subpanel { display: none; }
    .subpanel.active { display: block; }

    footer {
      margin-top: 16px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
    }

    /* Flowchart */
    .flowchart {
      display: grid;
      gap: 12px;
    }

    .fcNode {
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 10px;
      padding: 14px;
      position: relative;
    }

    .fcNode h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .fcNode p {
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .fcTag {
      position: absolute;
      top: 10px;
      right: 10px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--primary-dark);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--primary-lighter);
    }

    .fcArrow {
      display: grid;
      place-items: center;
      height: 18px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      user-select: none;
    }

    .fcDecision {
      display: grid;
      place-items: center;
      padding: 18px 0 16px;
    }

    .fcDiamond {
      width: min(160px, 30vw);
      height: min(160px, 30vw);
      transform: rotate(45deg);
      border-radius: 12px;
      border: 2px solid var(--primary);
      background: var(--primary-lighter);
      position: relative;
      overflow: hidden;
    }

    .fcDiamondInner {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 20px;
      transform: rotate(-45deg);
      text-align: center;
    }

    .fcDiamondInner h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .fcDiamondInner p {
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .fcBranches {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
      margin-top: 18px;
    }

    @media (min-width: 940px) {
      .fcBranches { grid-template-columns: 1fr 1fr; }
    }

    .fcBranchLabel {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 8px;
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .fcChip {
      font-family: var(--mono);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--muted);
    }

    /* Compact Flow Tables */
    .flowTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 16px;
    }
    .flowTable th, .flowTable td {
      padding: 10px 12px;
      text-align: left;
      border: 1px solid var(--border);
    }
    .flowTable th {
      background: var(--primary-lighter);
      color: var(--primary-dark);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .flowTable td {
      background: var(--white);
      color: var(--text);
    }
    .flowTable tr:hover td {
      background: var(--bg);
    }
    .flowTable .step-num {
      width: 36px;
      text-align: center;
      font-family: var(--mono);
      font-weight: 600;
      color: var(--primary);
    }
    .flowTable .component {
      width: 100px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--primary-dark);
    }
    .flowTable .section-header {
      background: var(--primary);
      color: white;
      font-weight: 600;
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .flowTable code {
      font-size: 10px;
      padding: 1px 4px;
    }

    /* Compact Code Block */
    .codeBlock {
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.6;
      color: var(--text);
      background: #1e293b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 16px;
      overflow-x: auto;
      white-space: pre;
      color: #e2e8f0;
    }
    .codeBlock .comment { color: #94a3b8; }
    .codeBlock .highlight { color: #38bdf8; }
    .codeBlock .keyword { color: #a78bfa; }
    .codeBlock .success { color: #4ade80; }
    .codeBlock .warn { color: #fbbf24; }

    /* Compact Grid */
    .compactGrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (min-width: 768px) {
      .compactGrid { grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1024px) {
      .compactGrid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
    }

    /* Mini Card */
    .miniCard {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
    }
    .miniCard h4 {
      margin: 0 0 6px;
      font-size: 11px;
      color: var(--primary-dark);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .miniCard p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .miniCard code {
      font-size: 10px;
      padding: 1px 4px;
    }

    /* Compact Steps */
    .compactSteps {
      display: grid;
      gap: 6px;
      margin-bottom: 16px;
    }
    .compactStep {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .compactStep .num {
      width: 20px;
      height: 20px;
      font-size: 10px;
      flex-shrink: 0;
    }
    .compactStep .content {
      flex: 1;
      min-width: 0;
    }
    .compactStep .title {
      font-size: 12px;
      color: var(--text);
      font-weight: 600;
    }
    .compactStep .desc {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Section Divider */
    .sectionDivider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0 14px;
    }
    .sectionDivider::before, .sectionDivider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .sectionDivider span {
      font-size: 11px;
      color: var(--primary-dark);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ElAuth – Project Overview & Flows</h1>
        <div class="badge" title="Summarized from docs/planning/*.md">
          <span>Planning view</span><span aria-hidden="true">•</span><span>Static HTML</span>
        </div>
      </div>
      <p class="subtitle">
        Overview first (from <code>docs/planning/elauth_flow.md</code>), then individual flows presented in tabs.
        This is intentionally a single self-contained file (no external libraries).
      </p>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <span class="pill"><b>Tenant</b> domain → config JSON</span>
        <span class="pill"><b>ElAuth</b> OTP/MagicLink/JWT + auth DB + workspaces</span>
        <span class="pill"><b>Accounts API</b> person/entity/membership</span>
      </div>
    </header>

    <main class="grid">
      <!-- Overview -->
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2>Project Overview (Design)</h2>
            <p>
              ElAuth is a config-driven authentication service. It loads a tenant config based on the requesting domain,
              builds forms accordingly, and coordinates authentication + verification with Accounts API.
            </p>
          </div>
          <div class="pill"><b>Source</b> <code>elauth_flow.md</code></div>
        </div>
        <div class="cardBody">
          <div class="">
            <div>
              <div class="sectionLabel"><span>Responsibilities</span><span class="pill"><b>Summary</b> what lives where</span></div>
              <div class="steps">
                <div class="step"><div class="num">E</div><div><p class="stepTitle">ElAuth (Auth Orchestration)</p><p class="stepMeta">Config-driven forms; signin/signup/recovery; OTP + magic link handling; JWT issuing; stores auth artifacts and workspace records.</p></div></div>
                <div class="step"><div class="num">A</div><div><p class="stepTitle">Accounts API (Identity/Domain Data)</p><p class="stepMeta">Stores person/entity/membership; handle existence + verification state; memberships define relationships and tags.</p></div></div>
                <div class="step"><div class="num">D</div><div><p class="stepTitle">Tenant Config by Domain</p><p class="stepMeta">Domain selects config JSON; config decides which fields appear in auth flows and basic behavior.</p></div></div>
                <div class="step"><div class="num">W</div><div><p class="stepTitle">Workspace Concept</p><p class="stepMeta">Workspace is stored in ElAuth (planned: <code>workspace_id</code>, <code>shortid</code>, creator handle). Linked back to person data in Accounts API.</p></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tabs -->
      <section class="card flowsCard">
        <div class="cardHeader">
          <div>
            <h2>Flows</h2>
            <p>
              Choose a flow tab to view the schematic steps.
            </p>
          </div>
          <div class="pill"><b>Sources</b> <code>docs/planning/*.md</code></div>
        </div>

        <div class="tabsContainer">
        <div class="tabs" role="tablist" aria-label="Flow tabs">
          <button class="tab" role="tab" id="tab-concepts" aria-controls="panel-concepts" aria-selected="true" data-panel="panel-concepts">Concepts</button>
          <button class="tab" role="tab" id="tab-customer" aria-controls="panel-customer" aria-selected="false" data-panel="panel-customer">End User Registration (Customer Registration)</button>
          <button class="tab" role="tab" id="tab-reg-new" aria-controls="panel-reg-new" aria-selected="false" data-panel="panel-reg-new">Client Registration</button>
          <button class="tab" role="tab" id="tab-signin" aria-controls="panel-signin" aria-selected="false" data-panel="panel-signin">Client Signin</button>
          <button class="tab" role="tab" id="tab-tenant-types" aria-controls="panel-tenant-types" aria-selected="false" data-panel="panel-tenant-types">Admin Panel</button>
          <button class="tab" role="tab" id="tab-invite" aria-controls="panel-invite" aria-selected="false" data-panel="panel-invite">Invite User</button>
          <button class="tab" role="tab" id="tab-recovery" aria-controls="panel-recovery" aria-selected="false" data-panel="panel-recovery">Account Recovery</button>
          <button class="tab" role="tab" id="tab-upgrade" aria-controls="panel-upgrade" aria-selected="false" data-panel="panel-upgrade">Customer → Client Upgrade</button>
          <button class="tab" role="tab" id="tab-logout" aria-controls="panel-logout" aria-selected="false" data-panel="panel-logout">Logout</button>
          <button class="tab" role="tab" id="tab-roles" aria-controls="panel-roles" aria-selected="false" data-panel="panel-roles">Roles & Permissions</button>
          <button class="tab" role="tab" id="tab-tokens" aria-controls="panel-tokens" aria-selected="false" data-panel="panel-tokens">JWT Token</button>
        </div>

        <div class="cardBody">
          <!-- Concepts -->
          <div class="tabpanel active" id="panel-concepts" role="tabpanel" aria-labelledby="tab-concepts">

            <!-- What is Contact Library -->
            <div class="sectionDivider"><span>What is Contact Library?</span></div>
            <div style="padding: 12px;">
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                The <b>Contact Library</b> is an ecosystem-wide database that stores one record per person.
                It uses phone or email (called a "handle") as the unique identifier — if two entries share the same phone, they're the same person.
              </p>
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Primary purpose: Data Analytics & Data-Driven Decisions.</b> The Contact Library tracks a person's journey
                across the entire ecosystem — across all workspaces and all resellers. When someone is a customer in Workspace A (under res-000),
                then becomes an employee in Workspace B (under res-001), and later creates their own Workspace C (under res-002) —
                all of this is linked to a single <code>contact_id</code>.
              </p>
              <p style="margin: 0 0 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Key insight:</b> Without Contact Library, each workspace and reseller would have isolated data.
                With Contact Library, we can make data-driven decisions by answering questions like:
                "How many customers later became workspace owners?", "Which reseller has the highest conversion rate?", or
                "What's the lifetime value of a contact across all resellers?"
              </p>
            </div>

            <!-- How Contact Library Gets Data -->
            <div class="sectionDivider"><span>How Contact Library Gets Data</span></div>
            <div class="codeBlock"><span class="keyword">ENTRY POINTS: What gets written to Contact Library</span>

┌──────────────────────────────┬──────────────────────────────┬──────────────────────────────┐
│ <span class="success">1. REGISTRATION</span>              │ <span class="highlight">2. EMPLOYEE INVITE</span>           │ <span class="warn">3. CUSTOMER CHECKOUT</span>         │
│ User signs up on auth domain │ Workspace admin invites to ws│ User purchases from store    │
├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤
│ enters phone/email           │ workspace admin enters email │ enters phone                 │
│        │                     │        │                     │        │                     │
│        ▼                     │        ▼                     │        ▼                     │
│   <span class="highlight">LOOKUP by handle</span>           │   <span class="highlight">LOOKUP by handle</span>           │   <span class="highlight">LOOKUP by handle</span>           │
│        │                     │        │                     │        │                     │
├────────┴─────────────────────┼────────┴─────────────────────┼────────┴─────────────────────┤
│ <span class="keyword">IF NOT FOUND (INSERT):</span>       │ <span class="keyword">IF NOT FOUND (INSERT):</span>       │ <span class="keyword">IF NOT FOUND (INSERT):</span>       │
│ • contact_id: generated      │ • contact_id: generated      │ • contact_id: generated      │
│ • handles: [{ value,         │ • handles: [{ value,         │ • handles: [{ value,         │
│     verified: false }]       │     verified: false }]       │     verified: false }]       │
│ • workspace_relationships:   │ • workspace_relationships:   │ • workspace_relationships:   │
│   [{ workspace_id,           │   [{ workspace_id,           │   [{ workspace_id,           │
│      reseller_id,            │      reseller_id,            │      reseller_id,            │
│      tag: <span class="success">creator</span> }]         │      tag: <span class="highlight">employee</span> }]        │      tag: <span class="warn">customer</span> }]        │
├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤
│ <span class="keyword">IF FOUND (UPDATE):</span>           │ <span class="keyword">IF FOUND (UPDATE):</span>           │ <span class="keyword">IF FOUND (UPDATE):</span>           │
│ • workspace_relationships:   │ • workspace_relationships:   │ • workspace_relationships:   │
│   <span class="success">PUSH</span> { workspace_id,       │   <span class="success">PUSH</span> { workspace_id,       │   <span class="success">PUSH</span> { workspace_id,       │
│         reseller_id,         │         reseller_id,         │         reseller_id,         │
│         tag: <span class="success">creator</span> }       │         tag: <span class="highlight">employee</span> }      │         tag: <span class="warn">customer</span> }      │
├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤
│ <span class="keyword">LATER (VERIFICATION):</span>        │ <span class="keyword">LATER (VERIFICATION):</span>        │ <span class="keyword">LATER (VERIFICATION):</span>        │
│ <span class="success">Required</span> (OTP/magic-link)    │ <span class="success">On invite click</span>              │ <span class="muted">Optional</span>                     │
│ • handles[].verified = <span class="success">true</span>  │ • handles[].verified = <span class="success">true</span>  │ • May stay unverified        │
└──────────────────────────────┴──────────────────────────────┴──────────────────────────────┘

<span class="muted">Note: Auth credentials (passwords) are stored in a SEPARATE table, not in Contact Library</span></div>

            <!-- What is a Reseller -->
            <div class="sectionDivider"><span>What is a Reseller?</span></div>
            <div style="padding: 12px;">
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                A <b>Reseller</b> is a partner who white-labels the platform and sells it under their own brand.
                Clients who sign up through a reseller's domain see the reseller's branding, not elSapiens.
              </p>
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>elSapiens is also a reseller</b> (res-000) — the "platform reseller". This creates uniformity:
                every workspace has a <code>reseller_id</code>, whether it's a direct elSapiens client (res-000)
                or a reseller's client (res-001, res-002, etc.).
              </p>
              <p style="margin: 0 0 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Key point:</b> A reseller is a <b>record</b>, not a workspace. Resellers don't have workspaces —
                they have clients who have workspaces. Each client workspace stores <code>reseller_id</code>
                to track which reseller it belongs to.
              </p>
            </div>

            <!-- Contact Library - Central Concept -->
            <div class="sectionDivider"><span>Contact Library - The Central Identity System</span></div>
            <div class="codeBlock"><span class="keyword">TREE STRUCTURE: Contact Library → Resellers → Workspaces</span>

                                    <span class="highlight">LOOKUP</span>
                          phone/email ──────────┐
                                                ▼
                    ┌───────────────────────────────────────────────┐
                    │            <span class="success">CONTACT LIBRARY</span>                    │
                    │         (Ecosystem-wide, ONE record)          │
                    │                                               │
                    │  contact_id: "cl-001"                         │
                    │  handles: [ phone, email ]                    │
                    │  <span class="warn">workspace_relationships: [...]</span>               │
                    └───────────────────────────────────────────────┘
                                        │
           ┌────────────────────────────┼────────────────────────────┐
           │                            │                            │
           ▼                            ▼                            ▼
┌───────────────────────────────┐  ┌───────────────────────────────┐  ┌───────────────────────────┐
│ <span class="success">RESELLER: res-000</span>             │  │ <span class="highlight">RESELLER: res-001</span>             │  │ <span class="warn">RESELLER: res-002</span>         │
│ (ElSapiens - Platform)        │  │ (Tech Partner)                │  │ (Other Reseller)          │
│                               │  │                               │  │                           │
│ <span class="muted">Password: "AAA"</span>               │  │ <span class="muted">Password: "BBB"</span>               │  │ <span class="muted">Password: "CCC"</span>           │
│ <span class="success">SSO ↔ within res-000</span>          │  │ <span class="success">SSO ↔ within res-001</span>          │  │ <span class="success">SSO ↔ within res-002</span>      │
│                               │  │                               │  │                           │
│ ┌───────────┐ ┌───────────┐   │  │ ┌───────────┐ ┌───────────┐   │  │ ┌───────────┐             │
│ │ WS-A      │ │ WS-B      │   │  │ │ WS-D      │ │ WS-E      │   │  │ │ WS-F      │             │
│ │ <span class="muted">cl-001</span>    │ │ <span class="muted">cl-001</span>    │   │  │ │ <span class="muted">cl-001</span>    │ │ <span class="muted">cl-001</span>    │   │  │ │ <span class="muted">cl-001</span>    │             │
│ │ <span class="success">creator</span>   │ │ <span class="highlight">employee</span>  │   │  │ │ <span class="success">creator</span>   │ │ <span class="highlight">employee</span>  │   │  │ │ <span class="warn">customer</span>  │             │
│ └───────────┘ └───────────┘   │  │ └───────────┘ └───────────┘   │  │ └───────────┘             │
│ ┌───────────┐                 │  │                               │  │                           │
│ │ WS-C      │                 │  │                               │  │                           │
│ │ <span class="muted">cl-001</span>    │                 │  │                               │  │                           │
│ │ <span class="warn">customer</span>  │                 │  │                               │  │                           │
│ └───────────┘                 │  │                               │  │                           │
└───────────────────────────────┘  └───────────────────────────────┘  └───────────────────────────┘
          <span class="bad">╳ NO SSO ╳</span>                       <span class="bad">╳ NO SSO ╳</span>

<span class="keyword">workspace_relationships[] stored IN Contact Library:</span>
┌─────────────────────────────────────────────────────────────────────────────┐
│  workspace_relationships: [                                                 │
│    { workspace_id: "ws-A", reseller_id: "<span class="success">res-000</span>", tag: "<span class="success">creator</span>" },        │
│    { workspace_id: "ws-B", reseller_id: "<span class="success">res-000</span>", tag: "<span class="highlight">employee</span>" },       │
│    { workspace_id: "ws-C", reseller_id: "<span class="success">res-000</span>", tag: "<span class="warn">customer</span>" },       │
│    { workspace_id: "ws-D", reseller_id: "<span class="highlight">res-001</span>", tag: "<span class="success">creator</span>" },        │
│    { workspace_id: "ws-E", reseller_id: "<span class="highlight">res-001</span>", tag: "<span class="highlight">employee</span>" },       │
│    { workspace_id: "ws-F", reseller_id: "<span class="warn">res-002</span>", tag: "<span class="warn">customer</span>" }        │
│  ]                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘

<span class="keyword">PRIMARY HANDLE: How We Identify a Contact</span>
┌─────────────────────────────────────────────────────────────────────────────┐
│  The <span class="highlight">primary handle</span> depends on the <span class="warn">process/flow</span>,                            │
│                                                                             │
│  ┌─────────────────┬─────────────────┬──────────────────────────────────┐   │
│  │ Process         │ Primary Handle  │ Secondary Handle                 │   │
│  ├─────────────────┼─────────────────┼──────────────────────────────────┤   │
│  │ <span class="success">Registration</span>    │ <span class="success">Phone</span>           │ Email (collected after)          │   │
│  │ <span class="highlight">Invite User</span>     │ <span class="highlight">Email</span>           │ Phone (user adds later)          │   │
│  │ <span class="warn">Customer Visit</span>  │ <span class="warn">Phone</span>           │ Email (optional)                 │   │
│  └─────────────────┴─────────────────┴──────────────────────────────────┘   │
│                                                                             │
│  <span class="keyword">HOW IT WORKS:</span>                                                              │
│  1. User/System provides primary handle (phone OR email based on process)   │
│  2. System looks up Contact Library using that handle                       │
│  3. If found → use existing contact_id                                      │
│  4. If not found → create new contact with this handle                      │
│                                                                             │
│  <span class="success">REGISTRATION:</span> Phone is primary                                             │
│  → User enters phone → lookup by phone → verify phone → collect email       │
│                                                                             │
│  <span class="highlight">INVITE:</span> Email is primary                                                   │
│  → Creator enters employee email → lookup by email → send invite            │
│  → Employee verifies email → adds phone later                               │
└─────────────────────────────────────────────────────────────────────────────┘</div>

            <!-- Workspace Contact - Local Data -->
            <div class="codeBlock"><span class="warn">WORKSPACE CONTACT: Each workspace has its OWN data (does NOT sync)</span>

<span class="keyword">WHAT IS A WORKSPACE?</span>
A workspace is a virtual business space identified through workspace_id. Created by a user (creator), it can have:
• Employees (invited team members)
• Customers (end users who purchase/interact)
• Its own data, settings, and operations

┌─────────────────────────────────────────────────────────────────────────────┐
│  Each workspace stores a <span class="highlight">Workspace Contact</span> record for the same person:      │
│                                                                             │
│  WS-A (Workspace Contact):          WS-B (Workspace Contact):               │
│  ├─ contact_id: "cl-001"            ├─ contact_id: "cl-001"                 │
│  ├─ tag: "creator"                  ├─ tag: "employee"                      │
│  ├─ data: { name: "John" }          ├─ data: { name: "J. Doe" }             │
│  └─ entities: [...]                 └─ entities: [...]                      │
│                                                                             │
│  <span class="bad">These do NOT auto-sync!</span>                                                    │
│  • WS-A employee updates name to "Johnny" → WS-B still shows "J. Doe"       │
│  • Each workspace manages its own local copy                                │
│  • Only <span class="success">contact_id</span> links them to the same person in Contact Library         │
└─────────────────────────────────────────────────────────────────────────────┘

<span class="keyword">WHY NO SYNC?</span>
• Workspace creator/employee may enter data differently for their context
• "John - Sales Lead" in WS-A vs "John Doe - Vendor" in WS-B
• Each workspace owns its local data for its operations
• Contact Library = global truth for analytics, Workspace Contact = local operations</div>

            <!-- Key Rules -->
            <div class="hint">
              <b>Key Rules:</b>
              Phone & Email are <b>globally unique</b> (one handle = one contact) •
              Max <b>1 creator</b> per reseller •
              Unlimited employee/customer •
              <b>SSO within reseller only</b> •
              Different password per reseller
            </div>

            <!-- Merge Behavior -->
            <div class="sectionDivider"><span>Merge Behavior: Contact Library vs Workspace</span></div>
            <div class="codeBlock"><span class="keyword">TWO TYPES OF MERGE - DIFFERENT BEHAVIOR</span>

┌─────────────────────────────────────────────────────────────────────────────┐
│  <span class="success">CONTACT LIBRARY (Ecosystem-wide):</span>                                          │
│  • System <span class="success">AUTO-MERGE</span> when user verifies handle belonging to another contact │
│  • User proves ownership of both handles → safe to merge automatically      │
│  • Audit trail created                                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  <span class="warn">WORKSPACE CONTACTS (Within a workspace):</span>                                   │
│  • <span class="warn">NO auto-merge</span> - requires workspace admin action                          │
│  • Duplicates flagged for workspace admin review                            │
│  • Workspace admin decides to merge or keep separate                        │
└─────────────────────────────────────────────────────────────────────────────┘

<span class="keyword">WHY DIFFERENT?</span>
• Contact Library: User proves identity by verifying handles → system can trust
• Workspace: Different people may have similar data → admin judgment needed</div>

            <!-- Core Entities - Compact -->
            <div class="sectionDivider"><span>Core Entities</span></div>
            <table class="flowTable">
              <tr><th>Entity</th><th>Scope</th><th>Purpose</th></tr>
              <tr>
                <td><b>Contact Library</b></td>
                <td>Ecosystem-wide</td>
                <td>Single source of truth for identity. Lookup by phone/email.</td>
              </tr>
              <tr>
                <td><b>Workspace Contact</b></td>
                <td>Per Workspace</td>
                <td>Workspace-specific view of a contact. Has admin_data, tag.</td>
              </tr>
              <tr>
                <td><b>Handle</b></td>
                <td>Contact Library</td>
                <td>Phone or email. Must be verified to be trusted.</td>
              </tr>
              <tr>
                <td><b>Auth Credentials</b></td>
                <td>Per Reseller</td>
                <td>Password scoped to reseller. Same person = different passwords per reseller.</td>
              </tr>
            </table>

            <!-- Tag vs Role -->
            <div class="sectionDivider"><span>Tag vs Role</span></div>
            <table class="flowTable">
              <tr><th>Aspect</th><th>TAG</th><th>ROLE</th></tr>
              <tr>
                <td><b>Purpose</b></td>
                <td>HOW user joined (classification)</td>
                <td>WHAT user can do (permissions)</td>
              </tr>
              <tr>
                <td><b>Values</b></td>
                <td><span class="success">Fixed:</span> creator | employee | customer</td>
                <td><span class="warn">Configurable:</span> superadmin, manager, etc.</td>
              </tr>
              <tr>
                <td><b>Set by</b></td>
                <td>System (based on how they joined)</td>
                <td>Admin (can change anytime)</td>
              </tr>
              <tr>
                <td><b>Stored in</b></td>
                <td>Contact Library + Workspace Contact</td>
                <td>JWT Token + Database</td>
              </tr>
            </table>
            <div class="codeBlock"><span class="keyword">EXAMPLE:</span> John in Workspace A
• <span class="success">tag: "employee"</span>    → He was invited (classification - doesn't change)
• <span class="warn">role: "manager"</span>    → He can manage team (permission - admin can change)</div>

            <!-- Handles -->
            <div class="sectionDivider"><span>Handles (Phone & Email)</span></div>
            <table class="flowTable">
              <tr><th>Property</th><th>Description</th></tr>
              <tr><td><code>type</code></td><td>"phone" or "email"</td></tr>
              <tr><td><code>value</code></td><td>The actual phone/email (globally unique)</td></tr>
              <tr><td><code>verified</code></td><td>User proved ownership via OTP/magic link</td></tr>
              <tr><td><code>hidden</code></td><td>Soft-deleted (preserved for analytics)</td></tr>
            </table>
            <div class="hint">
              <b>Key Rules:</b> Phone & email are <b>globally unique</b> (one handle = one contact) • A contact can have multiple handles • Only <b>verified</b> handles are trusted for auth
            </div>

            <!-- Data Ownership -->
            <div class="sectionDivider"><span>Data Ownership Rules</span></div>
            <table class="flowTable">
              <tr><th>Actor</th><th>Contact Library</th><th>Workspace Contact</th></tr>
              <tr>
                <td><b>Customer (End User)</b></td>
                <td><span class="success">READ + WRITE</span> own data</td>
                <td>READ only (sees partial admin_data)</td>
              </tr>
              <tr>
                <td><b>Workspace Admin</b></td>
                <td><span class="warn">NO direct writes</span> (only via verified handles)</td>
                <td><span class="success">READ + WRITE</span> admin_data, entities</td>
              </tr>
              <tr>
                <td><b>System</b></td>
                <td>INSERT on registration, UPDATE on verification</td>
                <td>INSERT on invite/registration</td>
              </tr>
            </table>

            <div class="codeBlock"><span class="keyword">THE "CUSTOMER = SOURCE OF TRUTH" RULE:</span>

<span class="success">WHAT IT MEANS:</span>
• Customer-entered data in Contact Library is authoritative
• If customer says their name is "John", that's the truth
• Workspace creator/employee cannot "correct" Contact Library data directly

<span class="highlight">CUSTOMER UPDATES (from within a workspace):</span>
• Customer updates their profile while inside a workspace
• Update writes to Contact Library (global record)
• <span class="warn">BUT only that workspace's relationship data is affected</span>
• Other workspaces see the updated data when they fetch from Contact Library
  (e.g., customer visits another client's website, enters phone → on verification, updated name is shown)
• Example: Customer changes name "John" → "Johnny" in Workspace A
  → Contact Library: name = "Johnny" (updated globally)
  → Workspace B: customer enters phone at checkout → lookup finds "Johnny"
  → Workspace Contact records (local copies) remain unchanged

<span class="warn">THE EXCEPTION (Indirect Writes via Verification):</span>
• Workspace creator/employee adds handle to Workspace Contact
• Customer verifies that handle (OTP)
• Verified handle gets pushed to Contact Library
• <span class="highlight">This is the ONLY way workspace data reaches Contact Library</span>

<span class="bad">WHY THIS MATTERS:</span>
• Prevents workspace creator/employee typos from corrupting ecosystem identity
• Maintains data quality for analytics
• Customer always controls their verified identity</div>

            <div class="codeBlock"><span class="warn">WORKSPACE CONTACT (separate from Contact Library):</span>

• Stores what <span class="highlight">workspace creator/employee</span> entered (or customer entered for that workspace)
• Used for <span class="highlight">workspace-level operations</span> (not ecosystem analytics)
• <span class="keyword">Can differ</span> from Contact Library data (local copy vs global truth)</div>

            <!-- Authentication Methods -->
            <div class="sectionDivider"><span>Authentication Methods</span></div>
            <table class="flowTable">
              <tr><th>Method</th><th>Use Case</th><th>How It Works</th></tr>
              <tr>
                <td><b>Password</b></td>
                <td>Primary login</td>
                <td>Email/phone + password → access granted</td>
              </tr>
              <tr>
                <td><b>OTP</b></td>
                <td>Phone/email verification, passwordless</td>
                <td>6-digit code sent via SMS/email, short expiry</td>
              </tr>
              <tr>
                <td><b>Magic Link</b></td>
                <td>Email passwordless login</td>
                <td>HMAC-signed link, single use, click to login</td>
              </tr>
              <tr>
                <td><b>2FA (TOTP)</b></td>
                <td>Extra security layer</td>
                <td>Password + 6-digit code from authenticator app</td>
              </tr>
            </table>

            <!-- Key Principles Summary -->
            <div class="sectionDivider"><span>Key Principles</span></div>
            <div class="compactGrid cols2">
              <div class="miniCard">
                <h4>Identity</h4>
                <p>• Phone & email globally unique<br>
                • contact_id links everything<br>
                • Verified handles = trusted identity</p>
              </div>
              <div class="miniCard">
                <h4>Data Flow</h4>
                <p>• Customer writes to Contact Library<br>
                • Admin writes to Workspace Contact<br>
                • Verified handles bridge the gap</p>
              </div>
              <div class="miniCard">
                <h4>Security</h4>
                <p>• OTP required for sensitive operations<br>
                • Short-lived access tokens<br>
                • Refresh tokens for session continuity</p>
              </div>
              <div class="miniCard">
                <h4>Analytics</h4>
                <p>• Contact Library enables cross-workspace tracking<br>
                • workspace_relationships[] = complete journey<br>
                • Soft-delete preserves historical data</p>
              </div>
            </div>

            <div class="hint">
              <b>Use This Tab As Reference:</b> Other tabs assume you understand these concepts. If something is unclear in a flow, come back here for the authoritative definition.
            </div>
          </div>

          <!-- Customer Journey (Flow 1) -->
          <div class="tabpanel" id="panel-customer" role="tabpanel" aria-labelledby="tab-customer">
            <!-- Data Model - Compact Grid -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>Contact Library (Global)</h4>
                <p>Source of truth. <code>handles[]</code> with verified flag, <code>entities[]</code>, <code>workspace_relationships[]</code></p>
              </div>
              <div class="miniCard">
                <h4>Entity</h4>
                <p>Business or Individual. Address, bank details, other info. Linked via <code>person_id</code></p>
              </div>
              <div class="miniCard">
                <h4>Workspace Contact</h4>
                <p>Per workspace. <b>Copy</b> of contact data + <code>contact_id</code> (ref to Contact Library). <code>tag</code>: customer/employee/creator</p>
              </div>
            </div>

            <!-- Flow Table -->
            <div class="sectionDivider"><span>Customer Registration Flow</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Action</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Visit</td><td>Customer visits e-commerce site (shop.clientbusiness.com)</td></tr>
              <tr><td class="step-num">2</td><td class="component">Input</td><td>Enter mobile number for registration/login</td></tr>
              <tr><td class="step-num">3</td><td class="component">OTP</td><td>Send & validate OTP via SMS</td></tr>
              <tr><td colspan="3" class="section-header">Check Contact Library by Phone</td></tr>
              <tr><td class="step-num">4a</td><td class="component">EXISTS</td><td>Pre-fill form with existing data (name, email, etc.)</td></tr>
              <tr><td class="step-num">4b</td><td class="component">NOT EXISTS</td><td>Show empty form, customer fills manually</td></tr>
              <tr><td class="step-num">5</td><td class="component">Submit</td><td><b>Customer data = Source of Truth</b> (only customer can update)</td></tr>
              <tr><td colspan="3" class="section-header">Update Contact Library</td></tr>
              <tr><td class="step-num">6a</td><td class="component">EXISTS</td><td>UPDATE contact (customer wins), set <code>handles[phone].verified=true</code>, add workspace_relationship</td></tr>
              <tr><td class="step-num">6b</td><td class="component">NOT EXISTS</td><td>INSERT new contact with phone handle (<code>verified:true</code>), add workspace_relationship</td></tr>
              <tr><td class="step-num">7</td><td class="component">Workspace</td><td>Create Workspace Contact: <b>copy</b> of contact data + <code>contact_id</code> (ref to Library), <code>tag: customer</code></td></tr>
              <tr><td class="step-num">8</td><td class="component">Done</td><td>Registration complete, customer can shop</td></tr>
            </table>

            <!-- Text-based Flowchart -->
            <div class="sectionDivider"><span>Visual Flow</span></div>
            <div class="codeBlock">                         ┌─────────────────────────┐
                         │  Customer visits site   │
                         └───────────┬─────────────┘
                                     ▼
                         ┌─────────────────────────┐
                         │   Enter mobile number   │
                         └───────────┬─────────────┘
                                     ▼
                         ┌─────────────────────────┐
                         │    Send & verify OTP    │
                         └───────────┬─────────────┘
                                     ▼
                         ┌─────────────────────────┐
                         │  Check Contact Library  │
                         └───────────┬─────────────┘
                                     ▼
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │ <span class="success">EXISTS: Pre-fill</span>  │             │ <span class="warn">NEW: Empty form</span>   │
        │   form with data  │             │  customer fills   │
        └─────────┬─────────┘             └─────────┬─────────┘
                  └────────────────┬────────────────┘
                                   ▼
                         ┌─────────────────────────┐
                         │   <span class="highlight">Submit form</span>           │
                         │ (customer = src truth)  │
                         └───────────┬─────────────┘
                                     ▼
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
        ┌───────────────────┐             ┌───────────────────┐
        │ <span class="success">EXISTS: UPDATE</span>    │             │ <span class="warn">NEW: INSERT</span>       │
        │ contact, set      │             │ contact with      │
        │ verified=true     │             │ verified=true     │
        └─────────┬─────────┘             └─────────┬─────────┘
                  └────────────────┬────────────────┘
                                   ▼
                         ┌─────────────────────────┐
                         │ <span class="keyword">Create Workspace Contact</span>│
                         │ <span class="highlight">COPY</span> of data + contact_id│
                         │ (ref to Library)        │
                         └───────────┬─────────────┘
                                     ▼
                         ┌─────────────────────────┐
                         │   <span class="success">Registration Done</span>     │
                         └─────────────────────────┘</div>

            <!-- Permissions + Rules Side by Side -->
            <div class="compactGrid">
              <div class="miniCard">
                <h4>Permissions</h4>
                <p><b>Customer:</b> UPDATE own data in Contact Library<br>
                <b>Workspace Admin:</b> READ only (cannot correct typos)<br>
                <b>Ecosystem Admin:</b> MERGE duplicates, investigate conflicts</p>
              </div>
              <div class="miniCard">
                <h4>Handle Conflict</h4>
                <p><b>Scenario:</b> Two contacts verify same phone<br>
                <b>Action:</b> Allow both to proceed<br>
                <b>Resolution:</b> Ecosystem Admin investigates later</p>
              </div>
            </div>

            <!-- Customer Data Management - Hidden Tag -->
            <div class="sectionDivider"><span>Customer Data Management: Hidden Tag</span></div>
            <div class="codeBlock"><span class="keyword">When customer DELETES verified data:</span>

<span class="warn">DON'T actually delete from Contact Library</span>
Instead: Add <span class="highlight">hidden: true</span> to that handle

┌─────────────────────────────────────────────────────────────┐
│  <span class="highlight">Contact Library - Handle Structure:</span>                        │
│                                                             │
│  handles: [                                                 │
│    { type: email,                                           │
│      value: "old@example.com",                              │
│      verified: true,                                        │
│      <span class="warn">hidden: true</span>  ← Customer deleted this                  │
│    },                                                       │
│    { type: email,                                           │
│      value: "new@example.com",                              │
│      verified: false,                                       │
│      <span class="success">hidden: false</span>  ← Customer added this (needs verify)    │
│    },                                                       │
│    { type: phone,                                           │
│      value: "+91-9876543210",                               │
│      verified: true,                                        │
│      <span class="success">hidden: false</span>  ← Active handle                         │
│    }                                                        │
│  ]                                                          │
└─────────────────────────────────────────────────────────────┘</div>

            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Customer Action</th><th>System Behavior</th><th>Analytics Impact</th></tr>
              <tr><td class="step-num">1</td><td><b>Deletes email</b></td><td>Set <code>hidden: true</code> on that handle</td><td>Data preserved for analytics</td></tr>
              <tr><td class="step-num">2</td><td><b>Next visit - form pre-fill</b></td><td>Only show handles where <code>hidden: false</code></td><td>Customer sees clean form</td></tr>
              <tr><td class="step-num">3</td><td><b>Re-enters SAME email</b></td><td>Set <code>hidden: false</code> (restore)</td><td>No re-verification needed</td></tr>
              <tr><td class="step-num">4</td><td><b>Enters NEW email</b></td><td>Add new handle, old stays hidden</td><td>Can track: "changed from A to B"</td></tr>
            </table>

            <div class="compactGrid cols2">
              <div class="miniCard">
                <h4>Why Hidden Tag?</h4>
                <p><b>Analytics:</b> Data never lost - track customer journey<br>
                <b>UX:</b> Customer sees what they expect (deleted = gone)<br>
                <b>Recovery:</b> Re-enter same data = instant restore (already verified)</p>
              </div>
              <div class="miniCard">
                <h4>Multiple Handles</h4>
                <p>Contact Library can have <b>multiple emails/phones</b><br>
                Old ones: <code>hidden: true</code> (preserved)<br>
                Current one: <code>hidden: false</code> (active)</p>
              </div>
            </div>

            <div class="hint">
              <b>Key Rules:</b> Customer = source of truth • <code>verified</code> is handle property (NOT tag) • <code>hidden: true</code> = soft delete (data preserved) • Pre-fill only shows <code>hidden: false</code> handles • Re-enter same data = restore (no re-verify) • Multiple handles allowed per type
            </div>
          </div>

          <!-- Invite -->
          <div class="tabpanel" id="panel-invite" role="tabpanel" aria-labelledby="tab-invite">
            <!-- Key Points - Compact Grid -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>Contact Library Lookup</h4>
                <p>Check by <b>EMAIL first</b>, then <b>PHONE</b> (within same <code>reseller_id</code>). If not found → create new with workspace admin data</p>
              </div>
              <div class="miniCard">
                <h4>Workspace Contact</h4>
                <p>Always stores <b>workspace admin-entered data</b> + <code>contact_id</code> + <code>reseller_id</code> reference. Status: <code>PENDING_INVITATION</code></p>
              </div>
              <div class="miniCard">
                <h4>Data Relationship</h4>
                <p>If contact EXISTS (in reseller) → <code>contact_id</code> reference only (no data copy)<br>If NOT EXISTS → workspace admin data pushed to both</p>
              </div>
            </div>

            <!-- Workspace Admin Invite Flow Table -->
            <div class="sectionDivider"><span>Workspace Admin Invite Flow</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Workspace Admin</td><td>Workspace admin clicks "Invite User" in workspace dashboard</td></tr>
              <tr><td class="step-num">2</td><td class="component">Form</td><td>Enters: email, phone, name, role (employee/workspace admin)</td></tr>
              <tr><td colspan="3" class="section-header">Contact Library Lookup (Email → Phone) within <code>reseller_id</code></td></tr>
              <tr><td class="step-num">3a</td><td class="component">EMAIL exists</td><td>Use existing <code>contact_id</code> <span class="muted">(reference only, no data copy)</span></td></tr>
              <tr><td class="step-num">3b</td><td class="component">PHONE exists</td><td>Use existing <code>contact_id</code> <span class="muted">(reference only, no data copy)</span></td></tr>
              <tr><td class="step-num">3c</td><td class="component">NEITHER exists</td><td><span class="warn">CREATE contact</span> skeleton with <code>reseller_id</code> (handles UNVERIFIED, empty workspace_relationships)</td></tr>
              <tr><td colspan="3" class="section-header">Workspace Contact</td></tr>
              <tr><td class="step-num">4</td><td class="component">Create</td><td>Workspace admin-entered data + <code>contact_id</code> + <code>reseller_id</code> ref + status: <code>PENDING_INVITATION</code></td></tr>
              <tr><td class="step-num">5</td><td class="component">Send</td><td>Email with invite link: <code>{reseller_domain}/invite?token=xxx</code></td></tr>
            </table>

            <!-- Visual Flowchart -->
            <div class="sectionDivider"><span>Visual Flow: Workspace Admin Invites User</span></div>
            <div class="codeBlock"><span class="keyword">Workspace Admin in dashboard (reseller_id: res-XXX)</span>
        │
        ▼
┌─────────────────────────────────────┐
│   Workspace Admin clicks "Invite User"│
│   Enters: email, phone, name, role  │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="highlight">Step 1:</span> Check EMAIL in Contact Library │
│   (within same reseller_id)         │
└─────────────────────────────────────┘
        │
        ├── <span class="success">EMAIL EXISTS</span> → Get contact_id (reference only)
        │                              │
        │                              ▼
        │                    ┌─────────────────────────────────────┐
        │                    │  <span class="keyword">Create Workspace Contact:</span>          │
        │                    │  • contact_id (reference)           │
        │                    │  • reseller_id: res-XXX             │
        │                    │  • <span class="highlight">Workspace admin-entered data</span>     │
        │                    │  • status: <span class="warn">PENDING_INVITATION</span>       │
        │                    └─────────────────────────────────────┘
        │
        └── <span class="warn">EMAIL NOT EXISTS</span> →
                │
                ▼
        ┌─────────────────────────────────────┐
        │   <span class="highlight">Step 2:</span> Check PHONE in Contact Library │
        │   (within same reseller_id)         │
        └─────────────────────────────────────┘
                │
                ├── <span class="success">PHONE EXISTS</span> → Get contact_id (reference only)
                │                              │
                │                              ▼
                │                    (Same: Create Workspace Contact
                │                     with workspace admin data + contact_id + reseller_id)
                │
                └── <span class="warn">PHONE NOT EXISTS</span> →
                        │
                        ▼

                ┌─────────────────────────────────────┐
                │  <span class="keyword">Create Workspace Contact:</span>          │
                │  • contact_id (no contact_id now)   │
                │  • reseller_id: res-XXX             │
                │  • <span class="highlight">Workspace admin-entered data</span>     │
                │  • status: <span class="warn">PENDING_INVITATION</span>       │
                └─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│  <span class="highlight">Send invitation email</span>              │
│  Link: {reseller_domain}/invite?token=xxx │
└─────────────────────────────────────┘</div>

            <!-- Scenario: User Registers Instead -->
            <div class="sectionDivider"><span>Scenario: User Registers Instead of Using Invite Link</span></div>
            <div class="codeBlock"><span class="keyword">User ignores invite email, goes to register directly</span>
        │
        ▼
┌─────────────────────────────────────┐
│   User enters SAME phone number     │
│   (phone exists but UNVERIFIED)     │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   Send OTP, user verifies PHONE     │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="success">USE EXISTING contact</span>              │
│   Update: phone.verified = true     │
│   <span class="warn">Email stays UNVERIFIED</span>            │
│   Create NEW workspace (registration)│
│   Add tag: workspace_creator        │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="keyword">User now has:</span>                     │
│   • Own workspace (creator)         │
│   • Pending invite to other workspace│
│   • Email still UNVERIFIED          │
└─────────────────────────────────────┘

<span class="keyword">IMPORTANT:</span> Same contact used for both!
            Registration creates new workspace
            Invite still pending on same contact</div>

            <!-- Scenario: User Accepts Invite -->
            <div class="sectionDivider"><span>Scenario: User Clicks Invite Link (with Phone Verification)</span></div>
            <div class="codeBlock"><span class="keyword">User clicks invite link in email</span>
        │
        ▼
┌─────────────────────────────────────┐
│   elauth.elsapiens.com/invite       │
│   ?token=xxx                        │
│                                     │
│   <span class="success">CLICK = EMAIL VERIFIED</span>            │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="highlight">Step 1:</span> Check EMAIL in Contact Lib│
└─────────────────────────────────────┘
        │
        ├── <span class="success">EMAIL EXISTS</span> → Use this contact_id
        │                 (skip phone check)
        │                         │
        │                         ▼
        │               ┌─────────────────────────────────────┐
        │               │   <span class="success">Complete Invite:</span>                  │
        │               │   • email.verified = true           │
        │               │   • Add tag: workspace_employee     │
        │               │   • Workspace Contact: ACTIVE       │
        │               │   • Redirect to workspace           │
        │               └─────────────────────────────────────┘
        │
        └── <span class="warn">EMAIL NOT EXISTS</span> →
                │
                ▼
        ┌─────────────────────────────────────┐
        │   <span class="highlight">Step 2:</span> Check PHONE in Contact Lib│
        └─────────────────────────────────────┘
                │
                ├── <span class="warn">PHONE NOT EXISTS</span> → Create new contact
                │                     (email verified, phone unverified)
                │                             │
                │                             ▼
                │                   (Complete Invite as above)
                │
                └── <span class="highlight">PHONE EXISTS</span> (Contact A found!) →
                        │
                        ▼
                ┌─────────────────────────────────────┐
                │   <span class="warn">UNCERTAIN: Same person?</span>           │
                │   Phone matches Contact A           │
                │   But email is NEW                  │
                │                                     │
                │   <span class="keyword">→ VERIFY PHONE via OTP</span>            │
                └─────────────────────────────────────┘
                        │
                        ├── <span class="success">OTP VERIFIED</span> → Same person!
                        │       │
                        │       ▼
                        │   ┌─────────────────────────────────────┐
                        │   │   <span class="success">Add new email to Contact A</span>        │
                        │   │   • email.verified = true (click)   │
                        │   │   • Add tag: workspace_employee     │
                        │   │   • Use Contact A's contact_id      │
                        │   │                                     │
                        │   │   <span class="warn">If email matches different</span>        │
                        │   │   <span class="warn">Contact B → DUPLICATE FLAGGED</span>     │
                        │   │   (Workspace admin reviews & merges)│
                        │   └─────────────────────────────────────┘
                        │
                        └── <span class="warn">OTP FAILED</span> → Different person
                                │
                                ▼
                        ┌─────────────────────────────────────┐
                        │   <span class="warn">Create NEW contact</span>                │
                        │   • email: verified (click)         │
                        │   • phone: UNVERIFIED               │
                        │   • Different from Contact A        │
                        └─────────────────────────────────────┘</div>

            <!-- Edge Cases Table -->
            <div class="sectionDivider"><span>Edge Cases & Handling</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Handling</th></tr>
              <tr><td class="step-num">1</td><td><b>Contact exists (verified)</b></td><td>Use existing contact, create workspace contact with PENDING_INVITATION</td></tr>
              <tr><td class="step-num">2</td><td><b>Contact exists (unverified)</b></td><td>Use existing contact, send invite</td></tr>
              <tr><td class="step-num">3</td><td><b>Contact doesn't exist</b></td><td><span class="warn">Create skeleton contact</span> (handles unverified, empty workspace_relationships), send invite</td></tr>
              <tr><td class="step-num">4</td><td><b>User registers instead</b></td><td>Use same contact, create their own workspace. <span class="highlight">Invite still pending</span></td></tr>
              <tr><td class="step-num">5</td><td><b>User accepts invite later</b></td><td><span class="highlight">Contact Library:</span> email verified + add workspace_relationship | <span class="highlight">Workspace Contact:</span> ACTIVE + tag: employee</td></tr>
              <tr><td class="step-num">6</td><td><b>Invite token expired</b></td><td><span class="warn">Show error</span>, admin must resend invite</td></tr>
              <tr><td class="step-num">7</td><td><b>User already in workspace</b></td><td>Show "Already a member" message</td></tr>
              <tr><td class="step-num">8</td><td><b>Same email invited twice</b></td><td>Use existing invite, resend notification</td></tr>
            </table>

            <!-- Workspace Contact Statuses -->
            <div class="compactGrid">
              <div class="miniCard">
                <h4>Workspace Contact Status</h4>
                <p><code>PENDING_INVITATION</code> - Invited but not accepted<br>
                <code>ACTIVE</code> - Accepted and working<br>
                <code>INACTIVE</code> - Deactivated by admin</p>
              </div>
              <div class="miniCard">
                <h4>Handle Uniqueness</h4>
                <p><b>Phone & Email</b> are UNIQUE in system<br>
                Unverified handle + verified elsewhere → <span class="highlight">Link to same contact</span><br>
                <span class="muted">(Contact merge = separate Flow 8)</span></p>
              </div>
            </div>

            <!-- Critical Edge Case: Invite Expires Mid-Flow -->
            <div class="sectionDivider"><span>Critical Edge Case: Invite Expires Mid-Flow</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Handling</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td><b>Token expires while filling form</b></td>
                <td>
                  <span class="warn">Check token validity before EACH step</span><br>
                  • Click link → Check valid ✓<br>
                  • Before phone OTP → Check valid ✓<br>
                  • Before final submit → Check valid ✓<br>
                  • If expired: <span class="warn">"Invite link expired. Request new invite from admin"</span>
                </td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td><b>Phone OTP verified, then token expires</b></td>
                <td>
                  <span class="success">PRESERVE phone verification!</span><br>
                  • Contact Library: phone.verified = true (keep)<br>
                  • Invite itself expired → Cannot complete join<br>
                  • <span class="highlight">On new invite:</span> Phone already verified, skip OTP step
                </td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td><b>Password set, then token expires</b></td>
                <td>
                  <span class="success">PRESERVE password!</span><br>
                  • Password saved in ElAuth → Keep it<br>
                  • Invite expired → User sees error<br>
                  • <span class="highlight">On new invite:</span> User already has password, skip that step
                </td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td><b>User clicks expired link (first click)</b></td>
                <td>
                  <span class="warn">"This invite has expired"</span><br>
                  • Show workspace name (for context)<br>
                  • Button: "Request New Invite" → Notify admin<br>
                  • Or: "Contact admin at [admin email]"
                </td>
              </tr>
              <tr>
                <td class="step-num">5</td>
                <td><b>Admin resends invite to same email</b></td>
                <td>
                  <span class="highlight">Smart resume:</span><br>
                  • Check what was already completed<br>
                  • Skip verified phone (if done)<br>
                  • Skip password (if set)<br>
                  • Resume from incomplete step
                </td>
              </tr>
            </table>

            <div class="codeBlock"><span class="keyword">INVITE EXPIRY HANDLING:</span>

┌─────────────────────────────────────────────────────────────┐
│ TOKEN CONTAINS:                                             │
│ • invite_id                                                 │
│ • workspace_id                                              │
│ • email (invited)                                           │
│ • expires_at (e.g., 7 days from creation)                   │
│ • created_by (admin user_id)                                │
└─────────────────────────────────────────────────────────────┘

<span class="keyword">VALIDATION CHECKPOINTS:</span>

User clicks link →
        │
        ▼
┌───────────────────────────────────────┐
│ CHECK 1: <span class="highlight">Is token expired?</span>            │
│ IF expired → Show expiry error        │
└───────────────────────────────────────┘
        │ valid
        ▼
┌───────────────────────────────────────┐
│ CHECK 2: <span class="highlight">Is invite still valid?</span>       │
│ (admin may have revoked)              │
│ IF revoked → "Invite cancelled"       │
└───────────────────────────────────────┘
        │ valid
        ▼
┌───────────────────────────────────────┐
│ CHECK 3: <span class="highlight">Is user already member?</span>      │
│ IF member → "You're already a member" │
│ → Redirect to signin                  │
└───────────────────────────────────────┘
        │ not member
        ▼
    Continue with invite flow...

<span class="keyword">EXPIRY DURING FLOW:</span>

┌───────────────────────────────────────────────────────────────┐
│ <span class="success">WHAT WE PRESERVE (even if token expires):</span>                     │
│ ✓ Phone verification (Contact Library updated)                │
│ ✓ Email verification (clicked link = verified)                │
│ ✓ Password (stored in ElAuth)                                 │
│ ✓ Any data already entered                                    │
├───────────────────────────────────────────────────────────────┤
│ <span class="warn">WHAT REQUIRES FRESH TOKEN:</span>                                    │
│ ✗ Adding user to workspace                                    │
│ ✗ Creating workspace contact record                           │
│ ✗ Assigning role                                              │
└───────────────────────────────────────────────────────────────┘

<span class="keyword">RESULT:</span> New invite = <span class="success">Fast completion</span> (most steps already done)</div>

            <div class="hint">
              <b>Key Rules:</b> Lookup order: EMAIL first → PHONE second • If EXISTS: <code>contact_id</code> reference only (no data copy) • If NOT EXISTS: admin data pushed to both Contact Library & Workspace Contact • Workspace Contact always has admin-entered data • Click invite link = Email VERIFIED (no OTP) • On accept: <b>Both</b> get <code>workspace_employee</code> tag • <span class="success">Preserve verifications</span> even if token expires
            </div>
          </div>

          <!-- Recovery -->
          <div class="tabpanel" id="panel-recovery" role="tabpanel" aria-labelledby="tab-recovery">
            <!-- Key Points -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>OTP Recovery</h4>
                <p>Works for <b>Phone & Email</b> (within same <code>reseller_id</code>). User enters handle → receives OTP → verifies → resets password</p>
              </div>
              <div class="miniCard">
                <h4>Magic Link</h4>
                <p><b>Email only</b> (within same <code>reseller_id</code>). User clicks link in email → auto-verified → resets password</p>
              </div>
              <div class="miniCard">
                <h4>Reseller Scoped</h4>
                <p>Recovery checks credentials within <code>reseller_id</code>. Same contact can have different passwords per reseller.</p>
              </div>
            </div>

            <!-- OTP Recovery Flow Steps -->
            <div class="sectionDivider"><span>OTP Recovery Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Entry</td><td>User clicks "Forgot Password" on <code>{reseller_domain}</code></td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config (e.g., res-001)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Branding</td><td>Load recovery form with <b>RESELLER branding</b></td></tr>
              <tr><td class="step-num">4</td><td class="component">Handle Input</td><td>User enters phone OR email address</td></tr>
              <tr class="section-header"><td colspan="3">HANDLE LOOKUP (PER-RESELLER)</td></tr>
              <tr><td class="step-num">5</td><td class="component">Lookup</td><td>Check handle exists in <code>auth_handles</code> WHERE <b>reseller_id = res-001</b></td></tr>
              <tr><td class="step-num">5a</td><td class="component warn">NOT EXISTS</td><td>Show generic "If account exists, OTP sent" (don't reveal)</td></tr>
              <tr><td class="step-num">5b</td><td class="component success">EXISTS</td><td>Continue to OTP generation</td></tr>
              <tr class="section-header"><td colspan="3">OTP GENERATION</td></tr>
              <tr><td class="step-num">6</td><td class="component">Create OTP</td><td>Store in <code>auth_handle_verifications</code>: OTP code + expiry + handle_ref + <b>reseller_id</b></td></tr>
              <tr><td class="step-num">7</td><td class="component">Send OTP</td><td>Via SMS (phone) or Email based on handle type</td></tr>
              <tr class="section-header"><td colspan="3">OTP VERIFICATION</td></tr>
              <tr><td class="step-num">8</td><td class="component">OTP Input</td><td>User enters 6-digit OTP code</td></tr>
              <tr><td class="step-num">9</td><td class="component">Verify</td><td>Check: code matches + not expired + same <b>reseller_id</b></td></tr>
              <tr><td class="step-num">9a</td><td class="component">Side Effect</td><td>If handle was UNVERIFIED → mark as <span class="success">VERIFIED</span></td></tr>
              <tr class="section-header"><td colspan="3">PASSWORD RESET</td></tr>
              <tr><td class="step-num">10</td><td class="component">Reset Token</td><td>Issue short-lived reset token for password change authorization</td></tr>
              <tr><td class="step-num">11</td><td class="component">New Password</td><td>User enters new password → Bcrypt hash</td></tr>
              <tr><td class="step-num">12</td><td class="component">Update</td><td>Update <code>auth_users</code> with new password_hash, invalidate OTP + reset token</td></tr>
            </table>

            <!-- Magic Link Recovery Flow Steps -->
            <div class="sectionDivider"><span>Magic Link Recovery Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Entry</td><td>User clicks "Forgot Password" on <code>{reseller_domain}</code> → selects Email Recovery</td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config (e.g., res-001)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Branding</td><td>Load recovery form with <b>RESELLER branding</b></td></tr>
              <tr><td class="step-num">4</td><td class="component">Email Input</td><td>User enters email address</td></tr>
              <tr class="section-header"><td colspan="3">EMAIL LOOKUP (PER-RESELLER)</td></tr>
              <tr><td class="step-num">5</td><td class="component">Lookup</td><td>Check email exists in <code>auth_handles</code> WHERE <b>reseller_id = res-001</b> (verified OR unverified)</td></tr>
              <tr><td class="step-num">5a</td><td class="component warn">NOT EXISTS</td><td>Show generic "If account exists, link sent" (don't reveal)</td></tr>
              <tr><td class="step-num">5b</td><td class="component success">EXISTS</td><td>Continue to magic link generation</td></tr>
              <tr class="section-header"><td colspan="3">MAGIC LINK GENERATION</td></tr>
              <tr><td class="step-num">6</td><td class="component">Generate Token</td><td>Create HMAC-SHA256 signed token (includes <b>reseller_id</b>)</td></tr>
              <tr><td class="step-num">7</td><td class="component">Store</td><td>Save in <code>auth_magic_links</code>: token + expiry + email_ref + <b>reseller_id</b> + used:false</td></tr>
              <tr><td class="step-num">8</td><td class="component">Send Email</td><td>Send recovery email with link: <code>{reseller_domain}/reset?token=xxx</code></td></tr>
              <tr class="section-header"><td colspan="3">LINK VERIFICATION</td></tr>
              <tr><td class="step-num">9</td><td class="component">Click Link</td><td>User clicks magic link in email</td></tr>
              <tr><td class="step-num">10</td><td class="component">Verify</td><td>Validate: signature + not expired + not used + same <b>reseller_id</b></td></tr>
              <tr><td class="step-num">10a</td><td class="component">Mark Used</td><td>Set <code>used: true</code> (single-use token)</td></tr>
              <tr><td class="step-num">10b</td><td class="component">Side Effect</td><td>If email was UNVERIFIED → mark as <span class="success">VERIFIED</span> (click = verify)</td></tr>
              <tr class="section-header"><td colspan="3">PASSWORD RESET</td></tr>
              <tr><td class="step-num">11</td><td class="component">New Password</td><td>Show password reset form, user enters new password</td></tr>
              <tr><td class="step-num">12</td><td class="component">Update</td><td>Bcrypt hash new password → Update <code>auth_users</code></td></tr>
            </table>

            <!-- Comparison Table -->
            <div class="sectionDivider"><span>OTP vs Magic Link Comparison</span></div>
            <table class="flowTable">
              <tr><th>Aspect</th><th>OTP Recovery</th><th>Magic Link</th></tr>
              <tr><td><b>Works for</b></td><td>Phone & Email</td><td>Email only</td></tr>
              <tr><td><b>User action</b></td><td>Enter OTP code</td><td>Click link</td></tr>
              <tr><td><b>Delivery</b></td><td>SMS or Email</td><td>Email only</td></tr>
              <tr><td><b>Token storage</b></td><td><code>auth_handle_verifications</code></td><td><code>auth_magic_links</code></td></tr>
              <tr><td><b>Reseller scoped</b></td><td>Yes (reseller_id in record)</td><td>Yes (reseller_id in token)</td></tr>
              <tr><td><b>Security</b></td><td>6-digit code, short expiry</td><td>HMAC-SHA256 signed, single use</td></tr>
              <tr><td><b>Side effect</b></td><td>Verifies handle if unverified</td><td>Verifies email if unverified</td></tr>
            </table>

            <div class="hint">
              <b>Key Rules:</b> Recovery is scoped to <code>reseller_id</code> • Don't reveal if handle exists (privacy) • OTP works for phone & email • Magic link is email-only • Same contact can have different passwords per reseller • Tokens must expire • Rate limit requests
            </div>
          </div>

          <!-- Client Registration (Flow 2) -->
          <div class="tabpanel" id="panel-reg-new" role="tabpanel" aria-labelledby="tab-reg-new">
            <!-- Key Rules - Compact Grid -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>Phone Check</h4>
                <p>Verify phone <b>FIRST</b> before collecting other details. Block if CREATOR/EMPLOYEE <b>for this reseller</b>.</p>
              </div>
              <div class="miniCard">
                <h4>Email Check</h4>
                <p><b>Block if CREATOR/EMPLOYEE</b> for this reseller. Same per-reseller logic as phone.</p>
              </div>
              <div class="miniCard">
                <h4>Reseller Scoped</h4>
                <p>Checks are <b>per-reseller</b>. User can have workspace under res-000 AND res-001 (different identities).</p>
              </div>
            </div>

            <!-- Client Registration Flow Steps -->
            <div class="sectionDivider"><span>Client Registration Flow</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Action</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Visit</td><td>Client visits auth domain (e.g., <code>auth.techpartner.com</code>)</td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config (e.g., res-001)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Branding</td><td>Load <b>RESELLER branding</b> (logo, colors, name) - NOT ElSapiens</td></tr>
              <tr><td class="step-num">4</td><td class="component">Landing</td><td>Show landing page with SIGNIN + REGISTER buttons</td></tr>
              <tr><td class="step-num">5</td><td class="component">Phone Input</td><td>User enters phone number for registration</td></tr>
              <tr><td colspan="3" class="section-header">Check Contact Library by Phone (Filter: reseller_id)</td></tr>
              <tr><td class="step-num">6a</td><td class="component">CREATOR/EMPLOYEE</td><td><span class="warn">BLOCK</span>: "Please signin instead" (for THIS reseller)</td></tr>
              <tr><td class="step-num">6b</td><td class="component">CUSTOMER only</td><td><span class="highlight">REDIRECT</span>: Follow "End User: New Workspace" flow</td></tr>
              <tr><td class="step-num">6c</td><td class="component">NO ENTRY</td><td><span class="success">ALLOW</span>: Continue registration (even if has other reseller entries)</td></tr>
              <tr><td class="step-num">7</td><td class="component">OTP</td><td>Send & validate OTP via SMS</td></tr>
              <tr><td class="step-num">8</td><td class="component">Phone Verified</td><td>Mark <code>handles[phone].verified=true</code> in Contact Library</td></tr>
              <tr><td class="step-num">9</td><td class="component">Email Input</td><td>User enters email address</td></tr>
              <tr><td colspan="3" class="section-header">Check Contact Library by Email (Filter: reseller_id)</td></tr>
              <tr><td class="step-num">10a</td><td class="component">CREATOR/EMPLOYEE</td><td><span class="warn">BLOCK</span>: "Email already in use" (for THIS reseller)</td></tr>
              <tr><td class="step-num">10b</td><td class="component">NO CREATOR/EMPLOYEE</td><td><span class="success">ALLOW</span>: Continue (email stored as UNVERIFIED)</td></tr>
              <tr><td class="step-num">11</td><td class="component">Details</td><td>Collect Name, Org name, Password</td></tr>
              <tr><td class="step-num">12</td><td class="component">Submit</td><td><b>User data = Source of Truth</b> (customer provides info)</td></tr>
              <tr><td colspan="3" class="section-header">Create Records (All Async)</td></tr>
              <tr><td class="step-num">13a</td><td class="component">EXISTS</td><td>UPDATE contact, add <code>workspace_relationship</code> with reseller_id + tag: creator</td></tr>
              <tr><td class="step-num">13b</td><td class="component">NOT EXISTS</td><td>INSERT new contact with phone handle (<code>verified:true</code>), add workspace_relationship</td></tr>
              <tr><td class="step-num">14</td><td class="component">Auth Credentials</td><td>Create: <code>contact_id</code> + <code>reseller_id</code> + <code>password_hash</code></td></tr>
              <tr><td class="step-num">15</td><td class="component">Workspace</td><td>Create workspace with <code>reseller_id</code> from domain config</td></tr>
              <tr><td class="step-num">16</td><td class="component">Workspace Contact</td><td>Create <b>copy</b> of contact data + <code>contact_id</code> ref, <code>tag: creator</code></td></tr>
              <tr><td class="step-num">17</td><td class="component">Dashboard</td><td>User enters dashboard (with RESELLER branding)</td></tr>
              <tr><td colspan="3" class="section-header">2FA Setup (Post Registration)</td></tr>
              <tr><td class="step-num">18</td><td class="component">2FA Prompt</td><td>System prompts: "Secure your account with 2FA"</td></tr>
              <tr><td class="step-num">18a</td><td class="component">SKIP</td><td>Remind later (can setup from Settings anytime)</td></tr>
              <tr><td class="step-num">18b</td><td class="component">SETUP NOW</td><td>Continue to authenticator setup</td></tr>
              <tr><td class="step-num">19</td><td class="component">QR Code</td><td>Display QR code (contains TOTP secret) for authenticator app</td></tr>
              <tr><td class="step-num">20</td><td class="component">Verify</td><td>User enters 6-digit code from authenticator app</td></tr>
              <tr><td class="step-num">21</td><td class="component">Backup Codes</td><td>Generate 10 one-time backup codes, user must save them</td></tr>
              <tr><td class="step-num">22</td><td class="component">Done</td><td><span class="success">2FA enabled</span>, registration complete</td></tr>
            </table>

            <!-- Reseller-Based Registration Check -->
            <div class="sectionDivider"><span>Reseller-Based Registration Check</span></div>
            <div class="codeBlock"><span class="keyword">REGISTRATION CHECK IS PER-RESELLER</span>

When user registers on a domain, system identifies the <span class="warn">reseller_id</span> from domain config.
Checks are filtered by this reseller_id only.

<span class="highlight">EXAMPLE: User registering on auth.techpartner.com (res-001)</span>

┌─────────────────────────────────────────────────────────────────────────────┐
│  Contact Library lookup by phone:                                           │
│                                                                             │
│  workspace_relationships: [                                                 │
│    { workspace_id: "ws-A", reseller_id: "<span class="success">res-000</span>", tag: "creator" },  ← <span class="muted">IGNORED</span> │
│    { workspace_id: "ws-B", reseller_id: "<span class="success">res-000</span>", tag: "employee" }, ← <span class="muted">IGNORED</span> │
│    { workspace_id: "ws-C", reseller_id: "<span class="warn">res-001</span>", tag: "customer" }, ← <span class="success">CHECKED</span> │
│  ]                                                                          │
│                                                                             │
│  Filter: WHERE reseller_id = "res-001"                                      │
│  Result: Only has "customer" tag for res-001 → <span class="success">ALLOW registration</span>           │
└─────────────────────────────────────────────────────────────────────────────┘

<span class="keyword">BLOCKING RULES (per reseller):</span>
┌──────────────────────────┬─────────────────────────────────────────────────┐
│ Has for THIS reseller    │ Result                                          │
├──────────────────────────┼─────────────────────────────────────────────────┤
│ <span class="warn">creator</span> tag              │ <span class="bad">BLOCK</span> - "You already have a workspace"          │
│ <span class="warn">employee</span> tag             │ <span class="bad">BLOCK</span> - "Please signin instead"                 │
│ <span class="success">customer</span> only            │ <span class="success">ALLOW</span> - Upgrade flow (create workspace)         │
│ No entry for reseller    │ <span class="success">ALLOW</span> - New user for this reseller              │
└──────────────────────────┴─────────────────────────────────────────────────┘

<span class="success">KEY POINT:</span> Same person can register on multiple resellers:
• res-000 (elSapiens): creator of WS-A
• res-001 (Tech Partner): creator of WS-D
→ Different passwords, different SSO sessions, separate identities per reseller</div>

            <!-- Visual Flowchart -->
            <div class="sectionDivider"><span>Registration Flow</span></div>
            <div class="codeBlock">Client visits auth domain (e.g., <span class="highlight">auth.techpartner.com</span>)
        │
        ▼
┌─────────────────────────────────────┐
│   System identifies <span class="warn">reseller_id</span>     │
│   from domain config (e.g., res-001)│
│   Loads <span class="highlight">RESELLER BRANDING</span>           │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   Show landing page with            │
│   <span class="highlight">RESELLER logo/colors</span>              │
│   NO TOKEN → "Register" button      │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   Show signup form (stays on        │
│   reseller's domain with branding)  │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="keyword">Enter PHONE</span> → Check Contact Lib   │
│   Filter by: <span class="warn">reseller_id = res-001</span>  │
└─────────────────────────────────────┘
        │
        ├── <span class="warn">CREATOR/EMPLOYEE</span> (for res-001) → BLOCK: "Please signin instead"
        │
        ├── <span class="highlight">CUSTOMER only</span> (for res-001) ──→ Follow "End User: New Workspace" flow
        │
        └── <span class="success">NO ENTRY for res-001</span> ────────→ Continue ↓ (even if has res-000 entry)
                │
                ▼
┌─────────────────────────────────────┐
│   Send OTP → User verifies phone    │
│   Contact Library: phone.verified   │
└─────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│   <span class="keyword">Enter EMAIL</span> → Check per reseller  │
│   Filter by: <span class="warn">reseller_id = res-001</span>  │
└─────────────────────────────────────┘
                │
                ├── <span class="warn">CREATOR/EMPLOYEE</span> (for res-001) → BLOCK: "Email already in use"
                │
                └── <span class="success">NO CREATOR/EMPLOYEE for res-001</span> → Continue ↓
                        │
                        ▼
┌─────────────────────────────────────┐
│   <span class="keyword">Collect Details</span> (config-driven)   │
│   Name, Org name, Password          │
└─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="keyword">ON SUBMIT - ALL ASYNC</span>                                     │
├─────────────────────────────────────────────────────────────┤
│   1. Generate UUIDs upfront                                 │
│   2. Fire-and-forget:                                       │
│      → Workspace (<span class="warn">reseller_id: res-001</span>)                     │
│      → Contact Library: add {ws_id, <span class="warn">reseller_id</span>, tag}       │
│      → Auth Credentials: (contact_id, <span class="warn">reseller_id</span>, hash)    │
│      → Workspace Contact (COPY + contact_id + [creator])    │
│   3. Generate JWT immediately                               │
│   4. Redirect to dashboard <span class="success">INSTANTLY</span> (RESELLER branding)    │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────┐
│   <span class="highlight">Dashboard checks workspace status</span> │
└─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ <span class="success">COMPLETE</span>    │ │ <span class="warn">INCOMPLETE</span>  │ │ <span class="warn">FAILED</span>      │
│ Show full   │ │ "Setting up │ │ Remove tag  │
│ dashboard   │ │ workspace"  │ │ Show error  │
└─────────────┘ │ + FCM wait  │ └─────────────┘
                └─────────────┘</div>

            <!-- Edge Cases -->
            <div class="sectionDivider"><span>Edge Cases (Per-Reseller)</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Decision</th></tr>
              <tr><td class="step-num">1</td><td>Phone exists, <b>UNVERIFIED</b> (for this reseller)</td><td><span class="success">Send new OTP</span> (treat as fresh attempt)</td></tr>
              <tr><td class="step-num">2</td><td>Phone exists, <b>CREATOR/EMPLOYEE for THIS reseller</b></td><td><span class="warn">BLOCK</span>: "Please signin instead"</td></tr>
              <tr><td class="step-num">3</td><td>Phone exists, <b>CUSTOMER only for THIS reseller</b></td><td><span class="highlight">Upgrade flow</span> (create workspace under this reseller)</td></tr>
              <tr><td class="step-num">4</td><td>Phone exists, <b>CREATOR for DIFFERENT reseller</b></td><td><span class="success">ALLOW</span> (separate identity per reseller)</td></tr>
              <tr><td class="step-num">5</td><td>Email exists, <b>CREATOR/EMPLOYEE for THIS reseller</b></td><td><span class="warn">BLOCK</span>: "Email already in use"</td></tr>
              <tr><td class="step-num">6</td><td>Email exists, <b>CREATOR for DIFFERENT reseller</b></td><td><span class="success">ALLOW</span> (separate identity per reseller)</td></tr>
              <tr><td class="step-num">7</td><td>Async operation fails</td><td>Retry queue → DLQ → remove tag, show error</td></tr>
            </table>

            <!-- Critical Edge Case: Browser closed mid-registration -->
            <div class="sectionDivider"><span><span class="warn">CRITICAL:</span> Browser Closed Mid-Registration</span></div>
            <div class="codeBlock"><span class="keyword">SCENARIO:</span> User verifies phone on auth.techpartner.com (res-001) → browser closes → returns later

<span class="highlight">STATE AT BROWSER CLOSE:</span>
┌─────────────────────────────────────────────────────────────┐
│   Contact Library:                                          │
│   • contact_id: "abc123" (created on phone input)           │
│   • phone: +91-xxx (<span class="success">VERIFIED</span>)                               │
│   • email: (not entered yet)                                │
│   • workspace_relationships: [] (empty for res-001)         │
│   • NO workspace created yet under res-001                  │
└─────────────────────────────────────────────────────────────┘
        │
        ▼ User returns to auth.techpartner.com (same or different device)
        │
┌─────────────────────────────────────────────────────────────┐
│   <span class="keyword">USER ENTERS PHONE AGAIN</span>                                   │
│   System checks Contact Library (filter: res-001):          │
│   • Phone exists: YES                                       │
│   • Phone verified: YES                                     │
│   • Has workspace_relationships for res-001: NO             │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="highlight">RESUME FLOW:</span>                                              │
│                                                             │
│   1. Send NEW OTP to verify still same person               │
│   2. On OTP success → Skip to "Collect Details" step        │
│   3. Pre-fill any data already in Contact Library           │
│   4. Continue registration normally (under res-001)         │
│                                                             │
│   <span class="success">Contact uses SAME contact_id</span> (no duplicate created)       │
└─────────────────────────────────────────────────────────────┘

<span class="warn">EDGE CASE WITHIN EDGE CASE:</span>
What if user returns after 30 days? → Still resume (contact_id preserved)
What if user returns to DIFFERENT reseller domain? → Fresh registration for that reseller</div>

            <!-- 2FA Setup -->
            <div class="sectionDivider"><span>2FA Setup (After Successful Registration)</span></div>
            <div class="codeBlock"><span class="keyword">2FA SETUP FLOW - POST REGISTRATION</span>

┌─────────────────────────────────────────────────────────────┐
│   <span class="success">REGISTRATION COMPLETE</span> → User enters Dashboard             │
│   System prompts: "Secure your account with 2FA"            │
└─────────────────────────────────────────────────────────────┘
        │
        ├── <span class="warn">SKIP</span> → Remind later (can setup from Settings)
        │
        └── <span class="success">SETUP NOW</span> → Continue ↓
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="keyword">STEP 1: AUTHENTICATOR APP SETUP</span>                           │
│                                                             │
│   1. Display QR code (contains TOTP secret)                 │
│   2. User scans with Google Authenticator / Authy / etc.    │
│   3. Show manual entry code as backup                       │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="keyword">STEP 2: VERIFY SETUP</span>                                      │
│                                                             │
│   User enters 6-digit code from authenticator app           │
│   System validates TOTP code                                │
│                                                             │
│   ├── <span class="warn">INVALID</span> → "Code incorrect, try again"                 │
│   │                                                         │
│   └── <span class="success">VALID</span> → Continue ↓                                    │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="keyword">STEP 3: BACKUP CODES</span>                                      │
│                                                             │
│   Generate 10 one-time backup codes                         │
│   Display: "Save these codes securely"                      │
│                                                             │
│   ┌─────────────────────────────────────┐                   │
│   │  XXXX-XXXX    XXXX-XXXX    XXXX-XXXX│                   │
│   │  XXXX-XXXX    XXXX-XXXX    XXXX-XXXX│                   │
│   │  XXXX-XXXX    XXXX-XXXX    XXXX-XXXX│                   │
│   │  XXXX-XXXX                          │                   │
│   └─────────────────────────────────────┘                   │
│                                                             │
│   User must acknowledge: "I have saved my backup codes"     │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   <span class="success">2FA ENABLED</span>                                               │
│                                                             │
│   • Auth Credentials updated: <code>2fa_enabled: true</code>            │
│   • TOTP secret stored (encrypted)                          │
│   • Backup codes stored (hashed)                            │
│   • Next signin will require 2FA code                       │
└─────────────────────────────────────────────────────────────┘</div>

            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">2FA Data</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">TOTP Secret</td><td>Stored encrypted in Auth Credentials (per reseller)</td></tr>
              <tr><td class="step-num">2</td><td class="component">Backup Codes</td><td>10 one-time codes, stored as hashed values</td></tr>
              <tr><td class="step-num">3</td><td class="component">2FA Flag</td><td><code>2fa_enabled: true</code> in Auth Credentials</td></tr>
              <tr><td class="step-num">4</td><td class="component">Recovery</td><td>User can use backup code if authenticator unavailable</td></tr>
            </table>

            <!-- Data Created -->
            <div class="sectionDivider"><span>Data Created</span></div>
            <div class="compactGrid">
              <div class="miniCard">
                <h4>Contact Library (Global)</h4>
                <p><code>handles:</code> phone (verified), email (UNVERIFIED)<br>
                <code>workspace_relationships:</code> [{ws_id, <b>reseller_id</b>, tag: creator}]<br>
                Source of truth for analytics</p>
              </div>
              <div class="miniCard">
                <h4>Auth Credentials</h4>
                <p><code>contact_id</code> + <code>reseller_id</code> + password_hash<br>
                Per-reseller credentials (same person, different passwords per reseller)</p>
              </div>
              <div class="miniCard">
                <h4>Workspace Contact</h4>
                <p>COPY of data + <code>contact_id</code> reference<br>
                <code>reseller_id:</code> from domain config<br>
                <code>tag:</code> creator</p>
              </div>
              <div class="miniCard">
                <h4>Workspace</h4>
                <p><code>workspace_id:</code> generated UUID<br>
                <code>reseller_id:</code> from domain config<br>
                User sees RESELLER branding</p>
              </div>
            </div>

            <div class="hint">
              <b>Key Rules:</b> Phone = primary (verify FIRST) • Email = secondary (same per-reseller blocking check) • Block if CREATOR/EMPLOYEE for this reseller • All async with pre-generated UUIDs • Credentials scoped to reseller
            </div>
          </div>


          <!-- Client Signin (Flow 3) -->
          <div class="tabpanel" id="panel-signin" role="tabpanel" aria-labelledby="tab-signin">
            <!-- Key Rules - Compact Grid -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>Reseller Scoped</h4>
                <p>Signin uses credentials for <b>this reseller only</b>. SSO works across reseller's domains.</p>
              </div>
              <div class="miniCard">
                <h4>Workspace Filter</h4>
                <p>Only show workspaces <b>under this reseller</b>. Max 1 creator workspace per reseller.</p>
              </div>
              <div class="miniCard">
                <h4>App List</h4>
                <p><b>Role-based</b> - each workspace shows apps based on user's tag (creator/employee).</p>
              </div>
            </div>

            <!-- Flow Table -->
            <div class="sectionDivider"><span>Signin Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Entry</td><td>User visits auth domain (e.g., <code>auth.techpartner.com</code>)</td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config (e.g., res-001)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Cookie Check</td><td>Check cookie storage for valid JWT token</td></tr>
              <tr><td class="step-num">3a</td><td class="component">HAS TOKEN</td><td><span class="success">Access dashboard directly</span> (with RESELLER branding)</td></tr>
              <tr><td class="step-num">3b</td><td class="component">NO TOKEN</td><td>Show signin form on reseller's domain</td></tr>
              <tr><td colspan="3" class="section-header">Auth Check (Per-Reseller)</td></tr>
              <tr><td class="step-num">4</td><td class="component">Config</td><td>Load config by domain, show signin form with <b>RESELLER branding</b></td></tr>
              <tr><td class="step-num">5</td><td class="component">Credentials</td><td>User enters identifier + password (credentials scoped to this reseller)</td></tr>
              <tr><td class="step-num">6</td><td class="component">Verify</td><td>Check Auth Credentials: <code>contact_id</code> + <code>reseller_id</code> + password_hash</td></tr>
              <tr><td colspan="3" class="section-header">2FA Check (If Enabled)</td></tr>
              <tr><td class="step-num">6b</td><td class="component">2FA Check</td><td>If user has 2FA enabled → show "Enter 2FA Code" screen</td></tr>
              <tr><td class="step-num">6c</td><td class="component">2FA Verify</td><td>Validate TOTP code from authenticator app (or backup code)</td></tr>
              <tr><td colspan="3" class="section-header">Workspace Check (Filter by Reseller)</td></tr>
              <tr><td class="step-num">7</td><td class="component">Query</td><td>Using <code>contact_id</code>, filter <code>workspace_relationships[]</code> WHERE <b>reseller_id = res-001</b></td></tr>
              <tr><td class="step-num">8</td><td class="component">Response</td><td>Return list of workspaces for THIS reseller only (ignores other resellers)</td></tr>
            </table>

            <!-- Visual Flowchart -->
            <div class="sectionDivider"><span>Visual Flow</span></div>
            <div class="codeBlock">User visits <span class="highlight">auth.techpartner.com</span> (res-001 domain)
        │
        ▼
┌─────────────────────────────────────┐
│   System identifies <span class="warn">reseller_id</span>     │
│   from domain config (res-001)      │
│   Loads <span class="highlight">RESELLER branding</span>           │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   Check cookie storage for token    │
└─────────────────────────────────────┘
        │
        ├── <span class="success">HAS VALID TOKEN</span> → Access dashboard (RESELLER branding)
        │
        └── <span class="warn">NO TOKEN / EXPIRED</span> →
                │
                ▼
        ┌─────────────────────────────────────┐
        │  Show signin form on reseller's     │
        │  domain with <span class="highlight">RESELLER logo/colors</span>   │
        └─────────────────────────────────────┘
                │
                ▼
        ┌─────────────────────────────────────┐
        │  User enters credentials            │
        │  (phone/email + password)           │
        └─────────────────────────────────────┘
                │
                ▼
        ┌─────────────────────────────────────┐
        │  <span class="keyword">Auth Credentials check:</span>            │
        │  contact_id + <span class="warn">reseller_id</span> + hash    │
        │  (per-reseller password)            │
        └─────────────────────────────────────┘
                │
                ├── <span class="warn">NOT EXISTS</span> → "No account found for this reseller"
                │
                └── <span class="success">EXISTS + MATCH</span> →
                        │
                        ▼
                ┌─────────────────────────────────────┐
                │  <span class="highlight">2FA ENABLED?</span>                       │
                └─────────────────────────────────────┘
                        │
                ├── <span class="muted">NO</span> → Continue to workspace check
                │
                └── <span class="warn">YES</span> →
                        │
                        ▼
                ┌─────────────────────────────────────┐
                │  Show "Enter 2FA Code" screen       │
                │  User enters code from app          │
                └─────────────────────────────────────┘
                        │
                ├── <span class="bad">INVALID CODE</span> → "Invalid 2FA code"
                │
                └── <span class="success">VALID CODE</span> →
                        │
                        ▼
                ┌─────────────────────────────────────┐
                │  <span class="keyword">Filter workspace_relationships:</span>    │
                │  WHERE <span class="warn">reseller_id = res-001</span>        │
                │  Tags: creator OR employee          │
                └─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ <span class="warn">ZERO</span> (for     │ │ <span class="success">SINGLE</span>        │ │ <span class="highlight">MULTIPLE</span>      │
│ res-001)      │ │ WORKSPACE     │ │ WORKSPACES    │
└───────┬───────┘ └───────┬───────┘ └───────┬───────┘
        │                 │                 │
        ▼                 │                 ▼
┌───────────────┐         │         ┌───────────────┐
│ Show Register │         │         │ Show          │
│ option (for   │         │         │ WORKSPACE     │
│ this reseller)│         │         │ SELECTOR      │
└───────────────┘         │         └───────┬───────┘
                          │                 │
                          │                 ├── If NO creator for res-001 →
                          │                 │   Show "+ Create Workspace"
                          │                 │
                          │                 ▼
                          │         ┌───────────────┐
                          │         │ User selects  │
                          │         │ workspace     │
                          │         └───────┬───────┘
                          │                 │
        ┌─────────────────┴─────────────────┤
        │                                   │
        ▼                                   ▼
┌───────────────────────┐   ┌───────────────────────┐
│ <span class="success">WITH return_url</span>       │   │ <span class="highlight">DIRECT signin</span>         │
│ Auto-redirect to      │   │ Show APP LIST         │
│ app dashboard         │   │ (with RESELLER brand) │
│ (RESELLER branding)   │   │ User picks app        │
└───────────────────────┘   └───────────────────────┘</div>

            <!-- Workspace Selector UI -->
            <div class="sectionDivider"><span>Workspace Selector UI (Per-Reseller)</span></div>
            <div class="codeBlock"><span class="warn">NOTE: Only shows workspaces for THIS reseller (res-001)</span>
User may have workspaces under res-000 but they won't appear here.

<span class="keyword">EXAMPLE 1: User has created a workspace under res-001</span>
┌─────────────────────────────────────────────────────────────┐
│ <span class="keyword">Select Workspace</span>  <span class="muted">(auth.techpartner.com - res-001)</span>          │
├─────────────────────────────────────────────────────────────┤
│ ○ ABC Corp <span class="success">(CREATOR)</span>         ← tag: creator (max 1 per reseller)│
│ ○ XYZ Inc <span class="highlight">(EMPLOYEE)</span>         ← tag: employee                │
│ ○ Partner Co <span class="highlight">(EMPLOYEE)</span>      ← tag: employee                │
├─────────────────────────────────────────────────────────────┤
│ <span class="muted">You already have a workspace under this reseller</span>            │
├─────────────────────────────────────────────────────────────┤
│                                        [<span class="success">Continue</span>]           │
└─────────────────────────────────────────────────────────────┘

<span class="keyword">EXAMPLE 2: User is ONLY employee for res-001 (no creator workspace)</span>
┌─────────────────────────────────────────────────────────────┐
│ <span class="keyword">Select Workspace</span>  <span class="muted">(auth.techpartner.com - res-001)</span>          │
├─────────────────────────────────────────────────────────────┤
│ ○ XYZ Inc <span class="highlight">(EMPLOYEE)</span>         ← tag: employee                │
│ ○ Partner Co <span class="highlight">(EMPLOYEE)</span>      ← tag: employee                │
├─────────────────────────────────────────────────────────────┤
│ <span class="warn">+ Create New Workspace</span>       ← No creator for res-001 yet   │
├─────────────────────────────────────────────────────────────┤
│                                        [<span class="success">Continue</span>]           │
└─────────────────────────────────────────────────────────────┘

<span class="keyword">When "Create New Workspace" clicked (SSO - already authenticated):</span>
   1. Create workspace (reseller_id: res-001)
   2. Add to workspace_relationships: {ws_id, reseller_id: res-001, tag: creator}
   3. Generate JWT with new workspace_id
   4. Redirect to dashboard (RESELLER branding)

<span class="keyword">RULE PER-RESELLER:</span>
• Max 1 creator workspace PER reseller
• Can be employee in unlimited workspaces per reseller
• Same person can be creator under res-000 AND res-001 (different identities)

<span class="keyword">SSO CREATE WORKSPACE FLOW (under current reseller):</span>
┌─────────────────────────────────────────────────────────────┐
│ User clicks "+ Create Workspace"                            │
└───────────────────────────┬─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ <span class="success">User already authenticated</span> for res-001                      │
└───────────────────────────┬─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Create workspace (<span class="warn">reseller_id: res-001</span>)                     │
│ Add to workspace_relationships: {ws, <span class="warn">res-001</span>, creator}      │
└───────────────────────────┬─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Generate JWT with workspace_id                              │
└───────────────────────────┬─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Redirect to dashboard (RESELLER branding)                   │
└───────────────────────────┬─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ <span class="highlight">INSIDE APP:</span> Collect organisation data                       │
│ (Address, GST, Bank details, Logo, etc.)                    │
└─────────────────────────────────────────────────────────────┘</div>

            <!-- App List UI (Direct ElAuth) -->
            <div class="sectionDivider"><span>App List UI (Direct ElAuth Visit - No return_url)</span></div>
            <div class="codeBlock">┌─────────────────────────────────────────────────────────────┐
│ <span class="keyword">Select Application</span>                                          │
│ <span class="muted">Apps available based on your role in this workspace</span>         │
├─────────────────────────────────────────────────────────────┤
│ ○ <span class="success">Attendance</span>      ○ <span class="success">CRM</span>             ○ <span class="muted">E-commerce (N/A)</span>      │
│ ○ <span class="success">Accounting</span>      ○ <span class="muted">Inventory (N/A)</span>  ○ <span class="success">ElTracker</span>            │
├─────────────────────────────────────────────────────────────┤
│                                        [<span class="success">Open App</span>]           │
└─────────────────────────────────────────────────────────────┘

<span class="keyword">Note:</span> Apps shown based on user's role in selected workspace
      <span class="muted">(N/A)</span> = User doesn't have access to this app in current workspace</div>

            <!-- Edge Cases Table -->
            <div class="sectionDivider"><span>Edge Cases & Handling (Per-Reseller)</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Handling</th></tr>
              <tr><td class="step-num">1</td><td><b>Zero workspaces for THIS reseller</b></td><td><span class="warn">Show Register option</span> - user may have ws under other reseller</td></tr>
              <tr><td class="step-num">2</td><td><b>Single workspace + return_url</b></td><td><span class="success">Auto-redirect</span> to app (RESELLER branding)</td></tr>
              <tr><td class="step-num">3</td><td><b>Single workspace + no return_url</b></td><td>Show <span class="highlight">app list</span> (RESELLER branding)</td></tr>
              <tr><td class="step-num">4</td><td><b>Multiple workspaces (for this reseller)</b></td><td>Show <span class="highlight">workspace selector</span> (filtered by reseller_id)</td></tr>
              <tr><td class="step-num">5</td><td><b>Only employee for this reseller</b></td><td>Show <span class="warn">"+ Create Workspace"</span> (creates under this reseller)</td></tr>
              <tr><td class="step-num">6</td><td><b>Credentials don't match for this reseller</b></td><td><span class="warn">"Invalid credentials"</span> (per-reseller password check)</td></tr>
              <tr><td class="step-num">7</td><td><b>No account for this reseller</b></td><td><span class="warn">"No account found for [Reseller Name]"</span></td></tr>
              <tr><td colspan="3" class="section-header">2FA Edge Cases</td></tr>
              <tr><td class="step-num">8</td><td><b>2FA code invalid</b></td><td><span class="warn">"Invalid 2FA code"</span> - allow retry (max 5 attempts)</td></tr>
              <tr><td class="step-num">9</td><td><b>2FA code expired</b></td><td>TOTP codes valid for 30 seconds - user enters next code</td></tr>
              <tr><td class="step-num">10</td><td><b>Lost authenticator app</b></td><td>Use <span class="highlight">backup code</span> (one-time use, user has 10)</td></tr>
              <tr><td class="step-num">11</td><td><b>All backup codes used</b></td><td>Contact support to disable 2FA (verify identity)</td></tr>
              <tr><td colspan="3" class="section-header">Token & Session Edge Cases</td></tr>
              <tr><td class="step-num">12</td><td><b>Token expired</b></td><td>Redirect to signin, <span class="success">preserve return_url</span></td></tr>
              <tr><td class="step-num">13</td><td><b>Workspace deactivated</b></td><td>Don't show in selector list</td></tr>
              <tr><td colspan="3" class="section-header">Critical Edge Case: Concurrent Signin / Password Changed</td></tr>
              <tr><td class="step-num">14</td><td><b>Password changed while session active</b></td><td>
                <span class="warn">Invalidate ALL existing tokens</span><br>
                • When password changes → update <code>password_changed_at</code> timestamp<br>
                • JWT validation: check <code>token_issued_at</code> &gt; <code>password_changed_at</code><br>
                • If token older than password change → <span class="warn">REJECT</span>, force re-login
              </td></tr>
              <tr><td class="step-num">15</td><td><b>Same user, multiple devices signin</b></td><td>
                <span class="success">ALLOW by default</span><br>
                • Each device gets its own JWT token<br>
                • All tokens share same <code>user_id</code>, different <code>session_id</code><br>
                • Optional: Workspace setting to limit concurrent sessions
              </td></tr>
              <tr><td class="step-num">16</td><td><b>Admin force-logout user</b></td><td>
                • Add user_id to <code>invalidated_sessions</code> Redis set<br>
                • Token validation middleware checks this set<br>
                • User sees "Session ended by administrator"
              </td></tr>
            </table>

            <!-- SSO Scope -->
            <div class="sectionDivider"><span>SSO Scope (Per-Reseller)</span></div>
            <div class="codeBlock"><span class="keyword">SSO WORKS ONLY WITHIN A RESELLER'S DOMAINS</span>

<span class="highlight">EXAMPLE: User signed in on auth.techpartner.com (res-001)</span>

┌─────────────────────────────────────────────────────────────┐
│  SSO <span class="success">VALID</span> for:                                             │
│  • auth.techpartner.com (res-001 reseller domain)           │
│  • auth.clientbusiness.com (res-001 client custom domain)   │
│  • Any other res-001 domain                                 │
├─────────────────────────────────────────────────────────────┤
│  SSO <span class="bad">NOT VALID</span> for:                                         │
│  • elauth.elsapiens.com (res-000 domain)                    │
│  • auth.otherreseller.com (res-002 domain)                  │
│  → User must signin separately for each reseller            │
└─────────────────────────────────────────────────────────────┘

<span class="keyword">WHY?</span> True white-label isolation:
• Each reseller is a separate identity system
• Same person, different credentials per reseller
• Client under reseller sees ONLY reseller branding</div>

            <!-- Token Structure -->
            <div class="compactGrid">
              <div class="miniCard">
                <h4>JWT Token Contents</h4>
                <p><code>contact_id</code> - from Contact Library<br>
                <code>reseller_id</code> - current reseller<br>
                <code>workspace_id</code> - selected workspace<br>
                <code>tag</code> - user's tag (creator/employee)<br>
                <code>exp</code> - expiration timestamp</p>
              </div>
              <div class="miniCard">
                <h4>Cookie Scope</h4>
                <p><b>Per reseller domain:</b><br>
                res-001: <code>.techpartner.com</code><br>
                res-000: <code>.elsapiens.com</code><br>
                <b>Security:</b> HttpOnly, Secure, SameSite</p>
              </div>
            </div>

            <div class="hint">
              <b>Key Rules:</b> Credentials are per-reseller • SSO works only within reseller's domains • Workspace list filtered by reseller_id • Max 1 creator per reseller • Same person can have accounts under multiple resellers (separate identities)
            </div>
          </div>

          <!-- Merge Contact (Flow 8) -->
          <!--  -->

          <!-- Customer to Client Upgrade -->
          <div class="tabpanel" id="panel-upgrade" role="tabpanel" aria-labelledby="tab-upgrade">
            <!-- Key Points -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>What is Upgrade?</h4>
                <p><b>Customer</b> (end user) becomes a <b>Client</b> (workspace creator) within the same <code>reseller_id</code></p>
              </div>
              <div class="miniCard">
                <h4>Reseller Scoped</h4>
                <p>Upgrade happens within same reseller. Customer under res-001 upgrades to client under res-001.</p>
              </div>
              <div class="miniCard">
                <h4>Key Principle</h4>
                <p>Same Contact Library entry + <code>reseller_id</code>, new <b>workspace_creator</b> relationship added</p>
              </div>
            </div>

            <!-- Upgrade Flow Steps -->
            <div class="sectionDivider"><span>Upgrade Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Entry</td><td>Customer visits <code>{reseller_domain}</code> and clicks "Register"</td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config (e.g., res-001)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Branding</td><td>Load registration form with <b>RESELLER branding</b></td></tr>
              <tr><td class="step-num">4</td><td class="component">Phone Input</td><td>Customer enters phone number</td></tr>
              <tr class="section-header"><td colspan="3">CONTACT LOOKUP (PER-RESELLER)</td></tr>
              <tr><td class="step-num">5</td><td class="component">Lookup</td><td>Check phone in Contact Library WHERE <b>reseller_id = res-001</b></td></tr>
              <tr><td class="step-num">5a</td><td class="component success">EXISTS</td><td>Phone found with role: CUSTOMER in this reseller</td></tr>
              <tr><td class="step-num">5b</td><td class="component">Role Check</td><td>Verify NOT OWNER/EMPLOYEE in this reseller (would block upgrade)</td></tr>
              <tr class="section-header"><td colspan="3">VERIFICATION</td></tr>
              <tr><td class="step-num">6</td><td class="component">Send OTP</td><td>Send OTP to customer's phone (verify they still own it)</td></tr>
              <tr><td class="step-num">7</td><td class="component">Verify OTP</td><td>Customer enters OTP code → validate within same <b>reseller_id</b></td></tr>
              <tr class="section-header"><td colspan="3">COLLECT DETAILS</td></tr>
              <tr><td class="step-num">8</td><td class="component">Details Form</td><td>Collect: Name, Email, Organization Name, etc.</td></tr>
              <tr><td class="step-num">9</td><td class="component">Email Check</td><td>Check email uniqueness within <b>reseller_id</b> (add as new handle if valid)</td></tr>
              <tr><td class="step-num">10</td><td class="component">Password</td><td>If no existing password for this reseller → collect and hash</td></tr>
              <tr class="section-header"><td colspan="3">WORKSPACE CREATION</td></tr>
              <tr><td class="step-num">11</td><td class="component">Create Workspace</td><td>Create new workspace with <b>reseller_id: res-001</b></td></tr>
              <tr><td class="step-num">12</td><td class="component">Update Contact</td><td>ADD to workspace_relationships: <code>{ws_id: B, reseller_id: res-001, role: OWNER}</code></td></tr>
              <tr><td class="step-num">13</td><td class="component success">Complete</td><td>Customer is now also a <span class="success">Client (Creator)</span> within same reseller</td></tr>
            </table>

            <!-- Visual Flowchart -->
            <div class="sectionDivider"><span>Visual Flow</span></div>
            <div class="codeBlock"><span class="keyword">Customer</span> (has Contact Library entry with reseller_id: res-XXX)
        │
        ▼
┌─────────────────────────────────────┐
│   Customer visits {reseller_domain} │
│   and clicks "Register"             │
│   (reseller_id from domain config)  │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="highlight">Enter Phone</span> → Check Contact Lib   │
│   (within same reseller_id)         │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="success">PHONE EXISTS</span> (Customer in res-XXX)│
│   Has role: CUSTOMER in this reseller│
│   NOT OWNER/EMPLOYEE in this reseller│
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="keyword">ALLOW REGISTRATION</span>                │
│   (Customer can become Creator      │
│    within same reseller)            │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="highlight">Verify OTP</span> → Collect Details      │
│   (Name, Email, Org Name, etc.)     │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="keyword">CREATE NEW WORKSPACE</span>              │
│   (Same contact, same reseller_id)  │
│   reseller_id: res-XXX              │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│   <span class="success">UPDATE Contact Library</span>            │
│   • ADD workspace_relationship:     │
│     {ws_id: B, reseller_id: res-XXX,│
│      role: OWNER}                   │
│   • Same contact_id                 │
└─────────────────────────────────────┘
        │
        ▼
<span class="success">Customer is now also a Client (within same reseller)!</span></div>

            <!-- Data Changes -->
            <div class="sectionDivider"><span>Data Changes</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Entity</th><th>Before</th><th>After</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td><b>Contact Library</b></td>
                <td>workspace_relationships: [{ws_id: A, reseller_id: res-XXX, role: CUSTOMER}]</td>
                <td>workspace_relationships: [{ws_id: A, reseller_id: res-XXX, role: CUSTOMER}, <span class="success">{ws_id: B, reseller_id: res-XXX, role: OWNER}</span>]</td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td><b>Workspace</b></td>
                <td>Customer of Workspace A (reseller_id: res-XXX)</td>
                <td>Customer of A + <span class="success">Creator of NEW Workspace B</span> (both under res-XXX)</td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td><b>Workspace Contact</b></td>
                <td>1 record (customer in A, reseller_id: res-XXX)</td>
                <td>2 records (customer in A, <span class="success">creator in B</span>) - same reseller</td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td><b>Auth Credentials</b></td>
                <td>Credentials for reseller_id: res-XXX</td>
                <td>Same credentials (password set if not already)</td>
              </tr>
            </table>

            <!-- Scenarios -->
            <div class="sectionDivider"><span>Scenarios</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Handling</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td><b>Customer has verified phone</b></td>
                <td>Send OTP to verify they still own the phone (within same reseller)</td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td><b>Customer has different email now</b></td>
                <td>Check new email uniqueness within reseller, add as new handle if valid</td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td><b>Customer already has password (for this reseller)</b></td>
                <td>Skip password collection, use existing credentials for this reseller_id</td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td><b>Customer is OWNER/EMPLOYEE in this reseller</b></td>
                <td><span class="warn">Block</span> - already has workspace in this reseller, signin instead</td>
              </tr>
              <tr>
                <td class="step-num">5</td>
                <td><b>Customer in res-001 wants workspace in res-002</b></td>
                <td>Different reseller = new registration flow (separate credentials)</td>
              </tr>
            </table>

            <!-- Key Rules -->
            <div class="hint">
              <b>Key Rules:</b> Upgrade is scoped to <code>reseller_id</code> • Same Contact Library entry used • Roles accumulate within reseller (customer + creator) • OWNER/EMPLOYEE in this reseller blocks upgrade • Can be customer in res-001 AND creator in res-002 (different resellers)
            </div>
          </div>

          <!-- Logout -->
          <div class="tabpanel" id="panel-logout" role="tabpanel" aria-labelledby="tab-logout">
            <!-- Key Points -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>What Happens</h4>
                <p>JWT token is <b>cleared from cookie storage</b>. User must re-authenticate to access protected resources</p>
              </div>
              <div class="miniCard">
                <h4>Reseller Context</h4>
                <p>Logout from <code>{reseller_domain}</code> clears token. Redirect goes back to <b>same reseller's</b> landing/signin page</p>
              </div>
              <div class="miniCard">
                <h4>Server-Side Cache</h4>
                <p><b>Must clear server cache</b> on logout (user data, permissions, session info cached in Redis/memory)</p>
              </div>
            </div>

            <!-- Logout Flow Steps -->
            <div class="sectionDivider"><span>Logout Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Trigger</td><td>User clicks "Logout" on <code>{reseller_domain}</code></td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from current session/domain</td></tr>
              <tr class="section-header"><td colspan="3">CLIENT-SIDE (ALWAYS SUCCEEDS)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Clear Cookie</td><td>Delete JWT token from cookie storage (domain: <code>.{reseller_domain}</code>)</td></tr>
              <tr><td class="step-num">4</td><td class="component">Local Storage</td><td>Clear any cached user preferences/data on frontend</td></tr>
              <tr class="section-header"><td colspan="3">SERVER-SIDE (BEST EFFORT)</td></tr>
              <tr><td class="step-num">5</td><td class="component">API Call</td><td>POST <code>/v1/auth/logout</code> with <b>reseller_id</b> context</td></tr>
              <tr><td class="step-num">6</td><td class="component warn">ElAuth Cache</td><td>Clear Redis/memory: user permissions, session data, workspace context for this reseller</td></tr>
              <tr><td class="step-num">7</td><td class="component warn">Service Caches</td><td>Clear permissions cached at <b>each service level</b> (ElCRM, ElChat, ElPages, etc.)</td></tr>
              <tr><td class="step-num">8</td><td class="component">Analytics</td><td>Log logout event (timestamp, user_id, reseller_id)</td></tr>
              <tr><td class="step-num">9</td><td class="component">Firebase</td><td>If push notifications enabled → revoke Firebase token</td></tr>
              <tr class="section-header"><td colspan="3">REDIRECT</td></tr>
              <tr><td class="step-num">10</td><td class="component success">Redirect</td><td>Send user to <code>{reseller_domain}/signin</code> or reseller's landing page</td></tr>
            </table>

            <!-- Multi-Workspace Scenario -->
            <div class="sectionDivider"><span>Multi-Workspace Scenario</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Scenario</th><th>Behavior</th></tr>
              <tr><td class="step-num">1</td><td class="component">Same Reseller</td><td>User in Workspaces A, B, C (all under res-001) → Single logout clears ALL</td></tr>
              <tr><td class="step-num">2</td><td class="component">Different Resellers</td><td>User in res-001 AND res-002 → Logout from res-001 only affects res-001 session</td></tr>
              <tr><td class="step-num">3</td><td class="component">Cookie Scope</td><td>Cookie is per reseller domain, not shared across resellers</td></tr>
            </table>

            <!-- Token Invalidation Note -->
            <div class="sectionDivider"><span>Token Behavior</span></div>
            <table class="flowTable">
              <tr><th>Aspect</th><th>Current (Stateless JWT)</th><th>Future (Token Blacklist)</th></tr>
              <tr>
                <td><b>Logout mechanism</b></td>
                <td>Delete cookie only</td>
                <td>Delete cookie + add to blacklist</td>
              </tr>
              <tr>
                <td><b>Token validity after logout</b></td>
                <td>Still valid until expiry (but user doesn't have it)</td>
                <td>Immediately invalid (checked against blacklist)</td>
              </tr>
              <tr>
                <td><b>Security tradeoff</b></td>
                <td>Simpler, faster validation</td>
                <td>More secure, requires DB check</td>
              </tr>
            </table>

            <!-- Critical Edge Case: Redis Down -->
            <div class="sectionDivider"><span>Critical Edge Case: Redis/Cache Failure During Logout</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Scenario</th><th>Handling</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td><b>Redis unreachable during logout</b></td>
                <td>
                  <span class="success">Still complete logout successfully</span><br>
                  • Cookie deletion is PRIMARY (always works)<br>
                  • Cache clearing is SECONDARY (best effort)<br>
                  • Log the cache failure for monitoring
                </td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td><b>Cache stale after failed clear</b></td>
                <td>
                  <span class="highlight">TTL handles cleanup</span><br>
                  • Cache has TTL (e.g., 15 minutes max)<br>
                  • Stale cache auto-expires<br>
                  • Next login will populate fresh cache
                </td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td><b>User re-logs in before cache expires</b></td>
                <td>
                  <span class="warn">Force cache refresh on login</span><br>
                  • Login always fetches fresh permissions<br>
                  • Overwrites any stale cached data<br>
                  • User gets correct state
                </td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td><b>Partial cache failure</b></td>
                <td>
                  • Track which keys failed to delete<br>
                  • Queue for retry via background job<br>
                  • Alert if failure rate exceeds threshold
                </td>
              </tr>
            </table>

            <div class="codeBlock"><span class="keyword">LOGOUT RESILIENCE STRATEGY:</span>

┌─────────────────────────────────────────────────────────────┐
│ PRIORITY 1: <span class="success">ALWAYS SUCCEED</span>                                  │
│ • Delete cookie (client-side) ✓                             │
│ • Clear local storage ✓                                     │
│ • Return success to user ✓                                  │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│ PRIORITY 2: <span class="highlight">BEST EFFORT</span>                                     │
│ • Clear ElAuth Redis cache (permissions, session)           │
│   └─ If fails → Log error, continue                         │
│ • <span class="warn">Clear SERVICE-LEVEL caches</span>                               │
│   └─ ElCRM permissions cache                                │
│   └─ ElChat permissions cache                               │
│   └─ ElPages permissions cache                              │
│   └─ If any fails → Log error, continue                     │
│ • Log analytics (with reseller_id)                          │
│   └─ If fails → Log error, continue                         │
│ • Revoke Firebase token                                     │
│   └─ If fails → Log error, continue                         │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│ FALLBACK: <span class="warn">SAFETY NETS</span>                                       │
│ • Cache TTL ensures auto-expiry                             │
│ • Login overwrites stale cache (all services)               │
│ • Background job retries failed deletions                   │
└─────────────────────────────────────────────────────────────┘</div>

            <div class="hint">
              <b>Key Rules:</b> Logout is scoped to <code>reseller_id</code> • Cookie cleared per reseller domain • <span class="warn">ElAuth cache + each service-level cache MUST be cleared</span> (ElCRM, ElChat, ElPages permissions) • Redirect to same reseller's signin • <span class="success">Logout never fails</span> - cache failure is logged but doesn't block user
            </div>
          </div>

          <!-- Roles & Permissions -->
          <div class="tabpanel" id="panel-roles" role="tabpanel" aria-labelledby="tab-roles">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 16px;">🚧</div>
              <h3 style="margin: 0 0 8px 0; color: var(--accent-yellow);">Under Development</h3>
              <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">This section is being restructured. Content coming soon.</p>
            </div>
          </div>

          <!-- JWT Token -->
          <div class="tabpanel" id="panel-tokens" role="tabpanel" aria-labelledby="tab-tokens">
            <!-- What are JWT Tokens -->
            <div class="compactGrid cols3">
              <div class="miniCard">
                <h4>What are JWT Tokens?</h4>
                <p><b>JSON Web Tokens</b> used for authentication and session management</p>
              </div>
              <div class="miniCard">
                <h4>Two Token System</h4>
                <p><b>Access Token</b> for API requests + <b>Refresh Token</b> for renewal</p>
              </div>
              <div class="miniCard">
                <h4>Reseller Scoped</h4>
                <p>Token contains <code>reseller_id</code>. Same user can have separate tokens per reseller.</p>
              </div>
            </div>

            <!-- Token Creation Flow Steps -->
            <div class="sectionDivider"><span>Token Creation Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">Login</td><td>User authenticates on <code>{reseller_domain}</code></td></tr>
              <tr><td class="step-num">2</td><td class="component">Reseller ID</td><td>System identifies <b>reseller_id</b> from domain config</td></tr>
              <tr><td class="step-num">3</td><td class="component">Verify</td><td>Validate credentials within same <b>reseller_id</b></td></tr>
              <tr class="section-header"><td colspan="3">TOKEN GENERATION</td></tr>
              <tr><td class="step-num">4</td><td class="component success">Access Token</td><td>Create JWT with: user_id, workspace_id, <b>reseller_id</b>, role, exp (24h)</td></tr>
              <tr><td class="step-num">5</td><td class="component warn">Refresh Token</td><td>Create refresh token with: user_id, <b>reseller_id</b>, exp (30d)</td></tr>
              <tr class="section-header"><td colspan="3">STORAGE</td></tr>
              <tr><td class="step-num">6</td><td class="component">Set Cookies</td><td>Store both tokens in HTTP-only cookies (domain: <code>.{reseller_domain}</code>)</td></tr>
              <tr><td class="step-num">7</td><td class="component">Response</td><td>Return success with workspace list (filtered by <b>reseller_id</b>)</td></tr>
            </table>

            <!-- Token Structure -->
            <div class="sectionDivider"><span>Token Structure</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Token</th><th>Lifetime</th><th>Purpose</th><th>Storage</th></tr>
              <tr><td class="step-num">1</td><td><code>access_token</code></td><td><span class="success">24 hours</span></td><td>Authenticate API requests</td><td>HTTP-only cookie</td></tr>
              <tr><td class="step-num">2</td><td><code>refresh_token</code></td><td><span class="warn">30 days</span></td><td>Get new access token without re-login</td><td>HTTP-only cookie (separate)</td></tr>
            </table>

            <!-- Access Token Payload -->
            <div class="sectionDivider"><span>Access Token Payload (JWT)</span></div>
            <div class="codeBlock"><span class="keyword">ACCESS_TOKEN</span> (decoded JWT payload)
{
  "<span class="highlight">user_id</span>": "usr_abc123",
  "<span class="highlight">workspace_id</span>": "ws_xyz789",
  "<span class="success">reseller_id</span>": "res-001",   <span class="muted">// Scoped to this reseller</span>
  "<span class="highlight">role</span>": "OWNER",
  "<span class="warn">iat</span>": 1705000000,           <span class="muted">// Issued at timestamp</span>
  "<span class="warn">exp</span>": 1705086400,           <span class="muted">// Expires in 24 hours</span>
  "type": "access"
}</div>

            <!-- Token Lifecycle -->
            <div class="sectionDivider"><span>Token Lifecycle Example</span></div>
            <div class="codeBlock"><span class="keyword">EXAMPLE TIMELINE:</span>

<span class="success">Day 1:</span>  Login → Get Access Token (24h) + Refresh Token (30d)
        │
        ├── API Request #1 → Send Access Token → <span class="success">✓ Valid</span>
        ├── API Request #2 → Send Access Token → <span class="success">✓ Valid</span>
        └── ... (all requests use Access Token)

<span class="warn">Day 2:</span>  Access Token expired!
        │
        ├── API Request → Send Access Token → <span class="bad">✗ Expired (401)</span>
        │
        ▼
        <span class="highlight">Auto-refresh flow:</span>
        ├── Send Refresh Token to /api/auth/refresh
        ├── Get NEW Access Token (24h)
        └── Retry original request → <span class="success">✓ Success</span>

<span class="warn">Day 3-29:</span>  Same pattern repeats...
        │
        ├── Access Token expires every 24h
        └── Refresh Token renews it automatically

<span class="bad">Day 30:</span>  Refresh Token expired!
        │
        ├── Cannot get new Access Token
        └── Must LOGIN again</div>

            <!-- Token Refresh Flow Steps -->
            <div class="sectionDivider"><span>Token Refresh Flow Steps</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th class="component">Step</th><th>Details</th></tr>
              <tr><td class="step-num">1</td><td class="component">API Request</td><td>Client sends request with expired access token</td></tr>
              <tr><td class="step-num">2</td><td class="component warn">401 Response</td><td>API returns <code>401 Unauthorized</code> (token expired)</td></tr>
              <tr class="section-header"><td colspan="3">AUTO-REFRESH (CLIENT-SIDE)</td></tr>
              <tr><td class="step-num">3</td><td class="component">Refresh Request</td><td>POST <code>/auth/refresh</code> with refresh_token (includes <b>reseller_id</b>)</td></tr>
              <tr><td class="step-num">4</td><td class="component">Validate</td><td>Verify refresh token: not expired, not blacklisted, same <b>reseller_id</b></td></tr>
              <tr><td class="step-num">5</td><td class="component success">New Access Token</td><td>Generate new access token with same <b>reseller_id</b> (24h)</td></tr>
              <tr><td class="step-num">6</td><td class="component">Token Rotation</td><td>Optionally issue new refresh token, invalidate old one</td></tr>
              <tr class="section-header"><td colspan="3">RETRY</td></tr>
              <tr><td class="step-num">7</td><td class="component">Retry Request</td><td>Client retries original API request with new access token</td></tr>
              <tr><td class="step-num">8</td><td class="component success">Success</td><td>API returns <code>200 OK</code></td></tr>
            </table>

            <!-- Token Flow Diagram -->
            <div class="sectionDivider"><span>Visual Flow</span></div>
            <div class="codeBlock"><span class="keyword">REFRESH FLOW:</span>

┌──────────┐         ┌──────────┐         ┌──────────┐
│  Client  │         │   API    │         │   Auth   │
└────┬─────┘         └────┬─────┘         └────┬─────┘
     │                    │                    │
     │ API Request        │                    │
     │ (expired token)    │                    │
     ├───────────────────►│                    │
     │                    │                    │
     │    <span class="bad">401 Unauthorized</span>│                    │
     │◄───────────────────┤                    │
     │                    │                    │
     │ POST /auth/refresh │                    │
     │ (refresh_token)    │                    │
     ├────────────────────┼───────────────────►│
     │                    │                    │
     │                    │   <span class="success">New Access Token</span> │
     │◄───────────────────┼────────────────────┤
     │                    │                    │
     │ Retry API Request  │                    │
     │ (new access token) │                    │
     ├───────────────────►│                    │
     │                    │                    │
     │       <span class="success">200 OK</span>       │                    │
     │◄───────────────────┤                    │
     │                    │                    │</div>

            <!-- Security Best Practices -->
            <div class="sectionDivider"><span>Security Considerations</span></div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Practice</th><th>Reason</th></tr>
              <tr><td class="step-num">1</td><td>Store tokens in <code>HTTP-only</code> cookies</td><td>Prevents XSS attacks from stealing tokens</td></tr>
              <tr><td class="step-num">2</td><td>Short Access Token lifetime (24h)</td><td>Limits damage if token is compromised</td></tr>
              <tr><td class="step-num">3</td><td>Refresh Token rotation</td><td>Issue new refresh token on each refresh, invalidate old one</td></tr>
              <tr><td class="step-num">4</td><td>Secure cookie flags</td><td><code>Secure</code>, <code>SameSite=Strict</code> for CSRF protection</td></tr>
              <tr><td class="step-num">5</td><td>Token blacklisting on logout</td><td>Invalidate refresh token when user logs out</td></tr>
            </table>

            <!-- Simple Summary -->
            <div class="sectionDivider"><span>Simple Summary</span></div>
            <div class="codeBlock"><span class="keyword">IN SIMPLE TERMS:</span>

┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  <span class="success">ACCESS TOKEN</span> = Your daily pass                             │
│     • Use it for everything                                 │
│     • Expires quickly (24h) for security                    │
│     • The JWT in your cookie                                │
│                                                             │
│  <span class="warn">REFRESH TOKEN</span> = Your backup key                            │
│     • Only used when access token expires                   │
│     • Gets you a new access token without login             │
│     • Lasts longer (30 days)                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘

<span class="highlight">WHY THIS MATTERS:</span>

Without Refresh Token:
  → Access Token expires → User must login again every 24h
  → <span class="bad">Bad UX!</span>

With Refresh Token:
  → Access Token expires → Auto-refresh in background
  → User stays logged in for 30 days
  → <span class="success">Seamless experience!</span></div>

            <div class="hint">
              <b>Key Rules:</b> Tokens are scoped to <code>reseller_id</code> • Access Token (24h) contains user_id, workspace_id, reseller_id, role • Refresh Token (30d) used to renew access token • Same user can have separate tokens per reseller • Cookies stored per reseller domain • Auto-refresh happens transparently
            </div>
          </div>

          <!-- Admin Panel -->
          <div class="tabpanel" id="panel-tenant-types" role="tabpanel" aria-labelledby="tab-tenant-types">

            <!-- Introduction -->
            <div class="sectionDivider"><span>Overview</span></div>
            <div style="padding: 12px;">
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>ElSapiens (res-000)</b> is the platform reseller with <code>commission_percentage: 0</code>.
                All other resellers (res-001, res-002, etc.) have their own commission rates.
              </p>
              <p style="margin: 0; line-height: 1.5; font-size: 0.85rem;">
                The Admin Panel provides <b>2 main functions</b>:
              </p>
            </div>

            <!-- Two Main Options Cards -->
            <div class="compactGrid cols2" style="margin-top: 12px;">
              <div class="miniCard">
                <h4>1. Add Reseller</h4>
                <p><b>Actor:</b> ElSapiens Admin only<br>
                Creates a new reseller partner (res-XXX) with their own domain, branding, and commission %.</p>
              </div>
              <div class="miniCard">
                <h4>2. Add Custom Domain / Add Client</h4>
                <p><b>Actor:</b> ElSapiens Admin or Reseller Admin<br>
                Add custom domain for existing client, or add new client with custom domain.</p>
              </div>
            </div>

            <!-- Reseller Data Model -->
            <div class="sectionDivider"><span>Reseller Data Model</span></div>
            <div class="codeBlock"><span class="keyword">RESELLERS TABLE:</span>
[
  { "reseller_id": "<span class="success">res-000</span>", "name": "ElSapiens", "is_ecosystem_owner": true, "commission_percentage": <span class="success">0</span> },
  { "reseller_id": "<span class="highlight">res-001</span>", "name": "Tech Partner", "is_ecosystem_owner": false, "commission_percentage": 15 },
  { "reseller_id": "<span class="warn">res-002</span>", "name": "Other Reseller", "is_ecosystem_owner": false, "commission_percentage": 20 }
]</div>

            <!-- Option 1: Add Reseller -->
            <div class="sectionDivider"><span>Option 1: Add Reseller</span></div>
            <div style="padding: 12px;">
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Who:</b> ElSapiens Admin only (admin.elsapiens.com)
              </p>
            </div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Step</th><th>Result</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td>Enter reseller details: name, domain, logo, brand color, admin email/phone</td>
                <td>-</td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td>Set commission percentage</td>
                <td>e.g., 15%</td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td>Set permissions: <code>allow_client_custom_domains</code>, <code>show_platform_branding</code></td>
                <td>-</td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td>System creates: Reseller record + Domain config + Admin contact</td>
                <td><code>reseller_id: "res-XXX"</code></td>
              </tr>
              <tr>
                <td class="step-num">5</td>
                <td>Setup email sent to reseller admin</td>
                <td>Admin sets password</td>
              </tr>
            </table>

            <!-- Option 2: Add Custom Domain / Add Client -->
            <div class="sectionDivider"><span>Option 2: Add Custom Domain / Add Client</span></div>
            <div style="padding: 12px;">
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Who:</b> ElSapiens Admin (for res-000 clients) or Reseller Admin (for their clients)
              </p>
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Note:</b> Reseller Admin can only do this if <code>allow_client_custom_domains: true</code>
              </p>
              <p style="margin: 0 0 0.75rem 0; line-height: 1.5; font-size: 0.85rem;">
                <b>Client Custom Domain:</b> Config file links <code>workspace_id</code> → Registration disabled (signin only). Workspace admin must invite users.
              </p>
            </div>

            <!-- Scenario A -->
            <div style="padding: 0 12px;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.85rem;">Scenario A: Add custom domain for EXISTING client</p>
            </div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Step</th><th>Result</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td>Select existing client workspace from list</td>
                <td>-</td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td>Enter custom domain (e.g., auth.clientbusiness.com)</td>
                <td>Domain uniqueness check</td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td>System creates domain config with <code>workspace_id</code></td>
                <td>Registration: disabled</td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td>Client configures DNS (CNAME/A record)</td>
                <td>Domain goes live</td>
              </tr>
            </table>

            <!-- Scenario B -->
            <div style="padding: 12px 12px 0;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; font-size: 0.85rem;">Scenario B: Add NEW client with custom domain</p>
            </div>
            <table class="flowTable">
              <tr><th class="step-num">#</th><th>Step</th><th>Result</th></tr>
              <tr>
                <td class="step-num">1</td>
                <td>Enter client details: name, workspace admin email/phone</td>
                <td>-</td>
              </tr>
              <tr>
                <td class="step-num">2</td>
                <td>Enter custom domain</td>
                <td>Domain uniqueness check</td>
              </tr>
              <tr>
                <td class="step-num">3</td>
                <td>System creates: Workspace + Domain config + Workspace admin contact</td>
                <td><code>workspace_id: "ws-XXX"</code></td>
              </tr>
              <tr>
                <td class="step-num">4</td>
                <td>Setup email sent to client workspace admin</td>
                <td>Workspace admin sets password</td>
              </tr>
              <tr>
                <td class="step-num">5</td>
                <td>Client configures DNS</td>
                <td>Domain goes live</td>
              </tr>
            </table>

            <div class="hint" style="margin-top: 16px;">
              <b>Key Points:</b> ElSapiens (res-000) has commission: 0 • Only ElSapiens admin can add resellers • Both ElSapiens and Reseller admins can add custom domains (if permitted) • Custom domains have registration disabled (signin only)
            </div>

          </div>
        </div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        Open locally with: <code>xdg-open docs/planning/flows.html</code>
      </div>
      <div style="margin-top:6px;">If you want, I can auto-generate this page from the markdown sources.</div>
    </footer>
  </div>

  <script>
    (function () {
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const panels = Array.from(document.querySelectorAll('.tabpanel'));

      function activate(panelId) {
        for (const tab of tabs) {
          const selected = tab.dataset.panel === panelId;
          tab.setAttribute('aria-selected', selected ? 'true' : 'false');
          tab.tabIndex = selected ? 0 : -1;
        }
        for (const panel of panels) {
          panel.classList.toggle('active', panel.id === panelId);
        }
        // Scroll to the tabs container when switching tabs
        const tabsContainer = document.querySelector('.tabsContainer');
        if (tabsContainer) {
          tabsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function initSubtabs(container) {
        const subtabs = Array.from(container.querySelectorAll(':scope > .subtabs .subtab'));
        const subpanels = Array.from(container.querySelectorAll(':scope > .subpanel'));
        if (!subtabs.length || !subpanels.length) return;

        function activateSub(subpanelId) {
          for (const tab of subtabs) {
            const selected = tab.dataset.subpanel === subpanelId;
            tab.setAttribute('aria-selected', selected ? 'true' : 'false');
            tab.tabIndex = selected ? 0 : -1;
          }
          for (const panel of subpanels) {
            panel.classList.toggle('active', panel.id === subpanelId);
          }
        }

        for (const tab of subtabs) {
          tab.addEventListener('click', () => activateSub(tab.dataset.subpanel));
          tab.addEventListener('keydown', (e) => {
            const idx = subtabs.indexOf(tab);
            if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
              e.preventDefault();
              const dir = e.key === 'ArrowRight' ? 1 : -1;
              const next = (idx + dir + subtabs.length) % subtabs.length;
              subtabs[next].focus();
              activateSub(subtabs[next].dataset.subpanel);
            }
          });
        }

        // If none is active, default to the first.
        const active = subpanels.find((p) => p.classList.contains('active'));
        if (!active) activateSub(subtabs[0].dataset.subpanel);

        return { activateSub, subtabs, subpanels };
      }

      for (const tab of tabs) {
        tab.addEventListener('click', () => activate(tab.dataset.panel));
        tab.addEventListener('keydown', (e) => {
          const idx = tabs.indexOf(tab);
          if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            e.preventDefault();
            const dir = e.key === 'ArrowRight' ? 1 : -1;
            const next = (idx + dir + tabs.length) % tabs.length;
            tabs[next].focus();
            activate(tabs[next].dataset.panel);
          }
        });
      }

      // Initialize each independent subtab group.
      const subtabGroups = Array.from(document.querySelectorAll('.tabpanel')).map(initSubtabs).filter(Boolean);

      // Deep link support: #panel-id
      const hash = (location.hash || '').replace('#', '');
      if (hash && document.getElementById(hash)) {
        if (hash.startsWith('subpanel-')) {
          const target = document.getElementById(hash);
          const group = subtabGroups.find((g) => g.subpanels.includes(target));
          if (group) group.activateSub(hash);
        } else {
          activate(hash);
        }
      }
    })();
  </script>
</body>
</html>
